<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPortal - Student Teacher Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Variables */
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --danger: #1dd1a1;
            --warning: #feca57;
            --purple: #9b59b6;
            --gradient-primary: linear-gradient(135deg, #7ab47d 0%, #4ba296 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #77a5ce 0%, #00f2fe 100%);
            --gradient-purple: linear-gradient(135deg, #e5a8ed 0%, #e99b6e 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
            overflow-x: hidden;
            position: relative;
            transition: background 0.5s ease;
        }

        /* Professional Color Themes */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .theme-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 10px;
            margin-top: 5px;
            display: none;
        }

        .theme-option {
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px 0;
            transition: background 0.3s ease;
        }

        .theme-option:hover {
            background: rgba(255,255,255,0.1);
        }

        body.theme-blue {
            background: linear-gradient(135deg, #75a1b4, #203a43, #2c5364);
        }

        body.theme-purple {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50, #fd3b2d);
        }

        body.theme-green {
            background: linear-gradient(135deg, #134e5e, #be2f66, #4ca1af);
        }

        body.theme-dark {
            background: linear-gradient(135deg, #0c0c0c, #2d2d2d, #1a1a1a);
        }

        body.theme-ocean {
            background: linear-gradient(135deg, #1a2980, #26d0ce, #1a2980);
        }

        /* Animated Background */
        .moving-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: inherit;
            z-index: -2;
        }

        .bubbles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bubble {
            position: absolute;
            bottom: -100px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: rise 15s infinite ease-in;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        /* Generate 30 bubbles with different properties */
        .bubble:nth-child(1) { left: 5%; width: 20px; height: 20px; animation-duration: 18s; animation-delay: 1s; }
        .bubble:nth-child(2) { left: 10%; width: 60px; height: 60px; animation-duration: 22s; animation-delay: 2s; }
        .bubble:nth-child(3) { left: 15%; width: 30px; height: 30px; animation-duration: 16s; animation-delay: 3s; }
        .bubble:nth-child(4) { left: 20%; width: 45px; height: 45px; animation-duration: 20s; animation-delay: 4s; }
        .bubble:nth-child(5) { left: 25%; width: 25px; height: 25px; animation-duration: 19s; animation-delay: 5s; }
        .bubble:nth-child(6) { left: 30%; width: 55px; height: 55px; animation-duration: 17s; animation-delay: 6s; }
        .bubble:nth-child(7) { left: 35%; width: 35px; height: 35px; animation-duration: 21s; animation-delay: 7s; }
        .bubble:nth-child(8) { left: 40%; width: 50px; height: 50px; animation-duration: 24s; animation-delay: 8s; }
        .bubble:nth-child(9) { left: 45%; width: 40px; height: 40px; animation-duration: 14s; animation-delay: 9s; }
        .bubble:nth-child(10) { left: 50%; width: 30px; height: 30px; animation-duration: 19s; animation-delay: 10s; }
        .bubble:nth-child(11) { left: 55%; width: 65px; height: 65px; animation-duration: 26s; animation-delay: 11s; }
        .bubble:nth-child(12) { left: 60%; width: 28px; height: 28px; animation-duration: 15s; animation-delay: 12s; }
        .bubble:nth-child(13) { left: 65%; width: 42px; height: 42px; animation-duration: 23s; animation-delay: 13s; }
        .bubble:nth-child(14) { left: 70%; width: 38px; height: 38px; animation-duration: 18s; animation-delay: 14s; }
        .bubble:nth-child(15) { left: 75%; width: 52px; height: 52px; animation-duration: 21s; animation-delay: 15s; }
        .bubble:nth-child(16) { left: 80%; width: 33px; height: 33px; animation-duration: 17s; animation-delay: 16s; }
        .bubble:nth-child(17) { left: 85%; width: 47px; height: 47px; animation-duration: 20s; animation-delay: 17s; }
        .bubble:nth-child(18) { left: 90%; width: 58px; height: 58px; animation-duration: 25s; animation-delay: 18s; }
        .bubble:nth-child(19) { left: 95%; width: 26px; height: 26px; animation-duration: 16s; animation-delay: 19s; }
        .bubble:nth-child(20) { left: 8%; width: 44px; height: 44px; animation-duration: 19s; animation-delay: 20s; }
        .bubble:nth-child(21) { left: 22%; width: 36px; height: 36px; animation-duration: 22s; animation-delay: 21s; }
        .bubble:nth-child(22) { left: 38%; width: 49px; height: 49px; animation-duration: 18s; animation-delay: 22s; }
        .bubble:nth-child(23) { left: 52%; width: 31px; height: 31px; animation-duration: 24s; animation-delay: 23s; }
        .bubble:nth-child(24) { left: 68%; width: 53px; height: 53px; animation-duration: 17s; animation-delay: 24s; }
        .bubble:nth-child(25) { left: 82%; width: 39px; height: 39px; animation-duration: 21s; animation-delay: 25s; }
        .bubble:nth-child(26) { left: 12%; width: 27px; height: 27px; animation-duration: 20s; animation-delay: 26s; }
        .bubble:nth-child(27) { left: 28%; width: 46px; height: 46px; animation-duration: 15s; animation-delay: 27s; }
        .bubble:nth-child(28) { left: 44%; width: 34px; height: 34px; animation-duration: 23s; animation-delay: 28s; }
        .bubble:nth-child(29) { left: 62%; width: 57px; height: 57px; animation-duration: 19s; animation-delay: 29s; }
        .bubble:nth-child(30) { left: 78%; width: 41px; height: 41px; animation-duration: 22s; animation-delay: 30s; }

        @keyframes rise {
            0% {
                bottom: -100px;
                transform: translateX(0) scale(1);
                opacity: 0.7;
            }
            50% {
                transform: translateX(100px) scale(1.2);
                opacity: 0.4;
            }
            100% {
                bottom: 1080px;
                transform: translateX(-50px) scale(0.8);
                opacity: 0;
            }
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .text-3d {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4), 4px 4px 10px rgba(0, 0, 0, 0.25);
            letter-spacing: 1px;
            transition: transform 0.3s ease, text-shadow 0.3s ease;
        }

        .text-3d:hover {
            transform: scale(1.05);
            text-shadow: 4px 4px 12px rgba(0, 0, 0, 0.5), 6px 6px 18px rgba(0, 0, 0, 0.3);
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Cards */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
        }

        .tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        /* Buttons */
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-purple {
            background: var(--gradient-purple);
            color: #333;
        }

        .btn-sm {
            padding: 10px 15px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Dashboard */
        .dashboard {
            display: flex;
            min-height: 80vh;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-right: 1px solid var(--glass-border);
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Profile */
        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
            color: white;
            background-size: cover;
            background-position: center;
        }

        /* Sidebar Menu */
        .sidebar-menu {
            list-style: none;
            margin-top: 30px;
        }

        .sidebar-menu li {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
        }

        .sidebar-menu li.active,
        .sidebar-menu li:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateX(5px);
        }

        /* Sections */
        .section-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #00c6ff, #a8edea);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4), 4px 4px 10px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
            transition: transform 0.3s ease, text-shadow 0.3s ease;
        }

        .section-title:hover {
            transform: scale(1.05);
            text-shadow: 4px 4px 12px rgba(0, 0, 0, 0.5), 6px 6px 18px rgba(0, 0, 0, 0.3);
        }

        .profile-header {
            text-align: center;
            margin-bottom: 40px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--glass-bg);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3), 2px 2px 8px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
            transition: transform 0.3s ease, text-shadow 0.3s ease;
        }

        .stat-number:hover {
            transform: scale(1.05);
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4), 3px 3px 10px rgba(0, 0, 0, 0.25);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .feature-card {
            background: var(--glass-bg);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            background: rgba(255, 255, 255, 0.15);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Course Cards */
        .course-card {
            text-align: left;
        }

        .enrollment-status {
            background: var(--secondary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* File Lists */
        .file-list {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .file-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Attendance */
        .attendance-graph {
            background: var(--glass-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
        }

        .graph-bar {
            height: 30px;
            background: var(--gradient-primary);
            border-radius: 15px;
            margin-bottom: 10px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Professional Attendance System */
        .attendance-student-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .attendance-student-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .student-profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .student-avatar-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            background-size: cover;
            background-position: center;
        }

        .student-details {
            flex: 1;
        }

        .student-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 5px;
        }

        .student-email {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 3px;
        }

        .student-roll {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
        }

        .attendance-status-section {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .attendance-percentage-display {
            text-align: center;
        }

        .percentage-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .percentage-high { color: #2ecc71; }
        .percentage-medium { color: #f39c12; }
        .percentage-low { color: #e74c3c; }

        .percentage-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }

        .attendance-options {
            display: flex;
            gap: 10px;
        }

        .attendance-option {
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .attendance-option.present {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border-color: #2ecc71;
        }

        .attendance-option.absent {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .attendance-option.late {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border-color: #f39c12;
        }

        .attendance-option.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
            transform: scale(1.05);
        }

        .attendance-option:hover:not(.selected) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Leaderboard Styles */
        .leaderboard-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            padding: 30px;
            margin-bottom: 30px;
        }

        .leaderboard-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 30px;
        }

        .leaderboard-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
        }

        .leaderboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .leaderboard-stat {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .leaderboard-winners {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .winner-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }

        .winner-card.gold {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1));
            border-color: #ffd700;
        }

        .winner-card.silver {
            background: linear-gradient(135deg, rgba(192,192,192,0.2), rgba(192,192,192,0.1));
            border-color: #c0c0c0;
        }

        .winner-card.bronze {
            background: linear-gradient(135deg, rgba(205,127,50,0.2), rgba(205,127,50,0.1));
            border-color: #cd7f32;
        }

        .winner-medal {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .winner-position {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .winner-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: white;
        }

        .winner-credits {
            font-size: 1.1rem;
            color: #2ecc71;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .credits-badge {
            background: var(--gradient-success);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Chatbot */
        .chatbot {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .chatbot-header {
            padding: 20px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .chatbot {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .attendance-student-card {
                flex-direction: column;
                gap: 20px;
            }
            
            .attendance-status-section {
                flex-direction: column;
                gap: 15px;
            }
            
            .attendance-options {
                justify-content: center;
            }
        }

        /* Animation for new elements */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>
<body class="moving-bg theme-blue">
    <!-- Theme Selector -->
    <div class="theme-selector">
        <button class="theme-btn" onclick="toggleThemeOptions()">
            <i class="fas fa-palette"></i> Theme
        </button>
        <div class="theme-options" id="themeOptions">
            <div class="theme-option" onclick="changeTheme('blue')">Blue Ocean</div>
            <div class="theme-option" onclick="changeTheme('purple')">Purple Mist</div>
            <div class="theme-option" onclick="changeTheme('green')">Green Forest</div>
            <div class="theme-option" onclick="changeTheme('dark')">Dark Professional</div>
            <div class="theme-option" onclick="changeTheme('ocean')">Deep Ocean</div>
        </div>
    </div>

    <!-- Animated Background Bubbles -->
    <div class="bubbles">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header floating">
            <h1 class="text-3d"><i class="fas fa-graduation-cap"></i> Mentora </h1>
            <p>Comprehensive Student & Teacher Management System</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="card">
            <div class="tabs">
                <div class="tab active" id="studentTab"><i class="fas fa-user-graduate"></i> Student Login</div>
                <div class="tab" id="teacherTab"><i class="fas fa-chalkboard-teacher"></i> Teacher Login</div>
                <div class="tab" id="parentTab"><i class="fas fa-users"></i> Parent Login</div>
                <div class="tab" id="registerTab"><i class="fas fa-user-plus"></i> Register</div>
            </div>
            
            <div id="loginForm">
                <h2 style="text-align: center; margin-bottom: 30px; color: white;" id="loginTitle"><i class="fas fa-user-graduate"></i> Student Login</h2>
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%;"><i class="fas fa-sign-in-alt"></i> Login</button>
            </div>

            <div id="registerForm" class="hidden">
                <h2 style="text-align: center; margin-bottom: 30px; color: white;"><i class="fas fa-user-plus"></i> Register New Account</h2>
                <div class="form-group">
                    <label><i class="fas fa-user-tag"></i> Account Type</label>
                    <select id="registerType" onchange="toggleRegisterFields()">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" id="registerName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Department</label>
                    <select id="registerDepartment">
                        <option value="computer_science">Computer Science</option>
                        <option value="electrical">Electrical Engineering</option>
                        <option value="mechanical">Mechanical Engineering</option>
                        <option value="civil">Civil Engineering</option>
                        <option value="business">Business Administration</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-camera"></i> Profile Photo</label>
                    <div class="photo-upload" onclick="document.getElementById('registerPhoto').click()" style="border: 2px dashed rgba(255,255,255,0.3); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; color: white;">
                        <img id="photoPreview" class="photo-preview" style="max-width: 100px; display: none;">
                        <p><i class="fas fa-cloud-upload-alt"></i> Click to upload profile photo</p>
                        <input type="file" id="registerPhoto" class="hidden" accept="image/*" onchange="previewPhoto(event)">
                    </div>
                </div>
                <div id="studentFields">
                    <div class="form-group">
                        <label><i class="fas fa-user-friends"></i> Father's Name</label>
                        <input type="text" id="registerFatherName" placeholder="Enter father's name">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-id-card"></i> Roll Number (Optional)</label>
                        <input type="text" id="registerRollNumber" placeholder="Leave blank for auto-generation">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Parent Email</label>
                        <input type="email" id="registerParentEmail" placeholder="Enter parent's email for parent portal">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Parent Password</label>
                        <input type="password" id="registerParentPassword" placeholder="Create password for parent portal">
                    </div>
                </div>
                <div id="teacherFields" class="hidden">
                    <div class="form-group">
                        <label><i class="fas fa-book"></i> Subject</label>
                        <input type="text" id="registerSubject" placeholder="Enter your subject">
                    </div>
                </div>
                <button class="btn btn-success" onclick="register()" style="width: 100%;"><i class="fas fa-user-plus"></i> Register</button>
                <p style="text-align: center; margin-top: 15px; color: white;">
                    Already have an account? <a href="#" onclick="showLoginForm('student')" style="color: var(--secondary);">Login here</a>
                </p>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="studentDashboard" class="hidden">
            <div class="dashboard">
                <div class="sidebar">
                    <div class="profile-pic" id="studentProfilePic" style="position: relative;">
                        <i class="fas fa-user-graduate"></i>
                        <div id="studentNotificationBadge" class="notification-badge hidden">0</div>
                    </div>
                    <h3 id="studentName" style="text-align: center; margin-bottom: 20px; color: white;"></h3>
                    <ul class="sidebar-menu">
                        <li class="active" onclick="showStudentSection('profile')"><i class="fas fa-user"></i> Profile</li>
                        <li onclick="showStudentSection('courses')"><i class="fas fa-book"></i> Available Courses</li>
                        <li onclick="showStudentSection('myCourses')"><i class="fas fa-graduation-cap"></i> My Courses</li>
                        <li onclick="showStudentSection('attendance')"><i class="fas fa-calendar-check"></i> Attendance</li>
                        <li onclick="showStudentSection('results')"><i class="fas fa-chart-line"></i> Results</li>
                        <li onclick="showStudentSection('assignments')"><i class="fas fa-tasks"></i> Assignments</li>
                        <li onclick="showStudentSection('timetable')"><i class="fas fa-calendar-alt"></i> Timetable</li>
                        <li onclick="showStudentSection('forum')"><i class="fas fa-comments"></i> Discussion Forum</li>
                        <li onclick="showStudentSection('leave')"><i class="fas fa-calendar-times"></i> Request Leave</li>
                        <li onclick="showStudentSection('previousPapers')"><i class="fas fa-file-alt"></i> Previous Papers</li>
                        <li onclick="showStudentSection('liveMeet')"><i class="fas fa-video"></i> Live Meetings</li>
                        <li onclick="showStudentSection('complaints')"><i class="fas fa-exclamation-circle"></i> Raise Complaint</li>
                        <li onclick="showStudentSection('leaderboard')"><i class="fas fa-trophy"></i> Monthly Leaderboard</li>
                        <li onclick="showStudentSection('notifications')"><i class="fas fa-bell"></i> Notifications</li>
                        <li onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
                    </ul>
                </div>
                <div class="content">
                    <div id="studentProfile" class="student-section">
                        <h2 class="section-title">Student Profile</h2>
                        <div class="profile-header">
                            <div class="profile-pic" id="studentProfilePicLarge"><i class="fas fa-user-graduate"></i></div>
                            <h3 id="studentProfileName" style="color: white;"></h3>
                            <p id="studentProfileEmail" style="color: white;"></p>
                            <p id="studentProfileDepartment" style="color: white;"></p>
                            <p id="studentProfileRollNumber" style="color: white;"></p>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="studentCoursesCount">0</div>
                                <div class="stat-label">Enrolled Courses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="studentAttendancePercent">0%</div>
                                <div class="stat-label">Overall Attendance</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="studentAssignmentsCount">0</div>
                                <div class="stat-label">Pending Assignments</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="studentCreditsCount">0</div>
                                <div class="stat-label">Performance Credits</div>
                            </div>
                        </div>
                        <div class="grid">
                            <div class="feature-card" onclick="showStudentSection('courses')">
                                <div class="feature-icon"><i class="fas fa-book"></i></div>
                                <h3>Available Courses</h3>
                                <p>Browse and enroll in available courses</p>
                            </div>
                            <div class="feature-card" onclick="showStudentSection('myCourses')">
                                <div class="feature-icon"><i class="fas fa-graduation-cap"></i></div>
                                <h3>My Courses</h3>
                                <p>View your enrolled courses</p>
                            </div>
                            <div class="feature-card" onclick="showStudentSection('attendance')">
                                <div class="feature-icon"><i class="fas fa-calendar-check"></i></div>
                                <h3>Attendance</h3>
                                <p>View your attendance records and statistics</p>
                            </div>
                            <div class="feature-card" onclick="showStudentSection('results')">
                                <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                                <h3>Results</h3>
                                <p>Check your grades and performance</p>
                            </div>
                            <div class="feature-card" onclick="showStudentSection('assignments')">
                                <div class="feature-icon"><i class="fas fa-tasks"></i></div>
                                <h3>Assignments</h3>
                                <p>Submit and track assignments</p>
                            </div>
                            <div class="feature-card" onclick="showStudentSection('timetable')">
                                <div class="feature-icon"><i class="fas fa-calendar-alt"></i></div>
                                <h3>Timetable</h3>
                                <p>View your class schedule</p>
                            </div>
                            <div class="feature-card" onclick="showStudentSection('leaderboard')">
                                <div class="feature-icon"><i class="fas fa-trophy"></i></div>
                                <h3>Leaderboard</h3>
                                <p>Check monthly rankings and credits</p>
                            </div>
                        </div>
                    </div>

                    <div id="studentCourses" class="student-section hidden">
                        <h2 class="section-title">Available Courses</h2>
                        <div id="availableCoursesContent"></div>
                    </div>

                    <div id="studentMyCourses" class="student-section hidden">
                        <h2 class="section-title">My Enrolled Courses</h2>
                        <div id="enrolledCoursesContent"></div>
                    </div>

                    <div id="studentAttendance" class="student-section hidden">
                        <h2 class="section-title">Attendance Records</h2>
                        <div class="attendance-graph">
                            <h3 style="color: white;">Attendance Overview</h3>
                            <div id="attendanceGraph"></div>
                        </div>
                        <div class="graph-container">
                            <h3 class="graph-title" style="color: white;">Subject-wise Attendance</h3>
                            <div id="subjectAttendanceGraph"></div>
                        </div>
                    </div>

                    <div id="studentResults" class="student-section hidden">
                        <h2 class="section-title">Academic Results</h2>
                        <div id="resultsContent"></div>
                    </div>

                    <div id="studentAssignments" class="student-section hidden">
                        <h2 class="section-title">Assignments</h2>
                        <div id="assignmentsContent"></div>
                    </div>

                    <div id="studentTimetable" class="student-section hidden">
                        <h2 class="section-title">Class Timetable</h2>
                        <div id="timetableContent"></div>
                    </div>

                    <div id="studentForum" class="student-section hidden">
                        <h2 class="section-title">Discussion Forum</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="forumCourseSelect" onchange="loadForumPosts()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <div id="forumContent"></div>
                    </div>

                    <div id="studentLeave" class="student-section hidden">
                        <h2 class="section-title">Request Leave</h2>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="leaveStartDate">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="leaveEndDate">
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <textarea id="leaveReason" placeholder="Enter reason for leave"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="submitLeaveRequest()">Submit Request</button>
                    </div>

                    <div id="studentPreviousPapers" class="student-section hidden">
                        <h2 class="section-title">Previous Question Papers</h2>
                        <div class="form-group">
                            <label>Select Subject</label>
                            <select id="paperSubject" onchange="loadPreviousPapers()">
                                <option value="mathematics">Mathematics</option>
                                <option value="physics">Physics</option>
                                <option value="programming">Programming</option>
                                <option value="all">All Subjects</option>
                            </select>
                        </div>
                        <div id="previousPapersContent" class="papers-container"></div>
                    </div>

                    <div id="studentLiveMeet" class="student-section hidden">
                        <h2 class="section-title">Live Meetings</h2>
                        <div id="liveMeetContent"></div>
                    </div>

                    <div id="studentComplaints" class="student-section hidden">
                        <h2 class="section-title">Raise Complaint</h2>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="complaintTitle" placeholder="Enter complaint title">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="complaintCategory">
                                <option value="academic">Academic</option>
                                <option value="infrastructure">Infrastructure</option>
                                <option value="faculty">Faculty</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="complaintDescription" placeholder="Describe your complaint in detail"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="submitComplaint()">Submit Complaint</button>
                    </div>

                    <div id="studentLeaderboard" class="student-section hidden">
                        <h2 class="section-title">üèÜ Monthly Leaderboard</h2>
                        <div class="leaderboard-container">
                            <div class="leaderboard-header">
                                <h3 class="leaderboard-title">Current Rankings</h3>
                                <div class="credits-display">
                                    <span class="credits-badge" id="studentCredits">0 Credits</span>
                                </div>
                            </div>
                            <div id="studentLeaderboardContent"></div>
                            <div id="studentPerformanceStats"></div>
                        </div>
                    </div>

                    <div id="studentNotifications" class="student-section hidden">
                        <h2 class="section-title">Notifications</h2>
                        <div id="notificationsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacherDashboard" class="hidden">
            <div class="dashboard">
                <div class="sidebar">
                    <div class="profile-pic" id="teacherProfilePic" style="position: relative;">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <div id="teacherNotificationBadge" class="notification-badge hidden">0</div>
                    </div>
                    <h3 id="teacherName" style="text-align: center; margin-bottom: 20px; color: white;"></h3>
                    <ul class="sidebar-menu">
                        <li class="active" onclick="showTeacherSection('profile')"><i class="fas fa-user"></i> Profile</li>
                        <li onclick="showTeacherSection('courses')"><i class="fas fa-plus-circle"></i> Create Course</li>
                        <li onclick="showTeacherSection('myCourses')"><i class="fas fa-book"></i> My Courses</li>
                        <li onclick="showTeacherSection('attendance')"><i class="fas fa-calendar-check"></i> Report Attendance</li>
                        <li onclick="showTeacherSection('performance')"><i class="fas fa-chart-line"></i> Student Performance</li>
                        <li onclick="showTeacherSection('grades')"><i class="fas fa-upload"></i> Upload Grades</li>
                        <li onclick="showTeacherSection('assignments')"><i class="fas fa-tasks"></i> Upload Assignments</li>
                        <li onclick="showTeacherSection('submissions')"><i class="fas fa-inbox"></i> Assignment Submissions</li>
                        <li onclick="showTeacherSection('timetable')"><i class="fas fa-calendar-alt"></i> Upload Timetable</li>
                        <li onclick="showTeacherSection('forum')"><i class="fas fa-comments"></i> Discussion Forum</li>
                        <li onclick="showTeacherSection('liveMeet')"><i class="fas fa-video"></i> Live Meetings</li>
                        <li onclick="showTeacherSection('previousPapers')"><i class="fas fa-file-alt"></i> Previous Papers</li>
                        <li onclick="showTeacherSection('semesterResults')"><i class="fas fa-graduation-cap"></i> Semester Results</li>
                        <li onclick="showTeacherSection('leaderboard')"><i class="fas fa-trophy"></i> Monthly Leaderboard</li>
                        <li onclick="showTeacherSection('complaints')"><i class="fas fa-exclamation-circle"></i> Student Complaints</li>
                        <li onclick="showTeacherSection('notifications')"><i class="fas fa-bell"></i> Notifications</li>
                        <li onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
                    </ul>
                </div>
                <div class="content">
                    <div id="teacherProfile" class="teacher-section">
                        <h2 class="section-title">Teacher Profile</h2>
                        <div class="profile-header">
                            <div class="profile-pic" id="teacherProfilePicLarge"><i class="fas fa-chalkboard-teacher"></i></div>
                            <h3 id="teacherProfileName" style="color: white;"></h3>
                            <p id="teacherProfileEmail" style="color: white;"></p>
                            <p id="teacherProfileDepartment" style="color: white;"></p>
                            <p id="teacherProfileSubject" style="color: white;"></p>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="teacherCoursesCount">0</div>
                                <div class="stat-label">Created Courses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="teacherStudentsCount">0</div>
                                <div class="stat-label">Total Students</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="teacherAssignmentsCount">0</div>
                                <div class="stat-label">Active Assignments</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="teacherLeaderboardsCount">0</div>
                                <div class="stat-label">Leaderboards Created</div>
                            </div>
                        </div>
                        <div class="grid">
                            <div class="feature-card" onclick="showTeacherSection('courses')">
                                <div class="feature-icon"><i class="fas fa-plus-circle"></i></div>
                                <h3>Create Course</h3>
                                <p>Create and manage courses</p>
                            </div>
                            <div class="feature-card" onclick="showTeacherSection('myCourses')">
                                <div class="feature-icon"><i class="fas fa-book"></i></div>
                                <h3>My Courses</h3>
                                <p>View your created courses</p>
                            </div>
                            <div class="feature-card" onclick="showTeacherSection('attendance')">
                                <div class="feature-icon"><i class="fas fa-calendar-check"></i></div>
                                <h3>Report Attendance</h3>
                                <p>Mark and manage student attendance</p>
                            </div>
                            <div class="feature-card" onclick="showTeacherSection('performance')">
                                <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                                <h3>Student Performance</h3>
                                <p>Track and report student performance</p>
                            </div>
                            <div class="feature-card" onclick="showTeacherSection('leaderboard')">
                                <div class="feature-icon"><i class="fas fa-trophy"></i></div>
                                <h3>Monthly Leaderboard</h3>
                                <p>Create and manage student rankings</p>
                            </div>
                        </div>
                    </div>

                    <div id="teacherCourses" class="teacher-section hidden">
                        <h2 class="section-title">Create New Course</h2>
                        <div class="form-group">
                            <label>Course Name</label>
                            <input type="text" id="courseName" placeholder="Enter course name">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="courseDescription" placeholder="Enter course description"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Duration</label>
                            <input type="text" id="courseDuration" placeholder="e.g., 1 semester, 3 months">
                        </div>
                        <div class="form-group">
                            <label>Upload Materials</label>
                            <div class="file-upload" onclick="document.getElementById('courseFile').click()" style="border: 2px dashed rgba(255,255,255,0.3); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; color: white;">
                                <p><i class="fas fa-cloud-upload-alt"></i> Click to upload course materials</p>
                                <input type="file" id="courseFile" class="hidden" multiple onchange="handleCourseFileUpload(this)">
                            </div>
                            <div id="courseFilesList" class="file-list"></div>
                        </div>
                        <button class="btn btn-primary" onclick="createCourse()">Create Course</button>
                    </div>

                    <div id="teacherMyCourses" class="teacher-section hidden">
                        <h2 class="section-title">My Created Courses</h2>
                        <div id="teacherCoursesContent"></div>
                    </div>

                    <div id="teacherAttendance" class="teacher-section hidden">
                        <h2 class="section-title">Report Attendance</h2>
                        <div class="attendance-container">
                            <div class="attendance-header">
                                <div>
                                    <h3 style="color: white;">Mark Student Attendance</h3>
                                    <p style="color: white;">Select a course and date to mark attendance</p>
                                </div>
                                <div class="attendance-date-picker">
                                    <i class="fas fa-calendar-alt" style="color: white;"></i>
                                    <input type="date" id="attendanceDate" value="">
                                </div>
                            </div>
                            
                            <div class="attendance-controls">
                                <div class="form-group" style="flex: 1;">
                                    <label>Select Course</label>
                                    <select id="attendanceCourse" onchange="loadCourseStudents()">
                                        <option value="">Select a course</option>
                                    </select>
                                </div>
                                <div class="attendance-bulk-actions">
                                    <button class="btn btn-success" onclick="markAllPresent()"><i class="fas fa-check-circle"></i> Mark All Present</button>
                                    <button class="btn btn-danger" onclick="markAllAbsent()"><i class="fas fa-times-circle"></i> Mark All Absent</button>
                                </div>
                            </div>
                            
                            <div id="courseStudentsList" class="attendance-students-list"></div>
                            
                            <div class="attendance-stats">
                                <div class="attendance-stat">
                                    <div class="attendance-stat-value" id="totalStudents" style="color: white;">0</div>
                                    <div class="attendance-stat-label" style="color: white;">Total Students</div>
                                </div>
                                <div class="attendance-stat">
                                    <div class="attendance-stat-value" id="presentCount" style="color: white;">0</div>
                                    <div class="attendance-stat-label" style="color: white;">Present</div>
                                </div>
                                <div class="attendance-stat">
                                    <div class="attendance-stat-value" id="absentCount" style="color: white;">0</div>
                                    <div class="attendance-stat-label" style="color: white;">Absent</div>
                                </div>
                                <div class="attendance-stat">
                                    <div class="attendance-stat-value" id="lateCount" style="color: white;">0</div>
                                    <div class="attendance-stat-label" style="color: white;">Late</div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 25px;">
                                <button class="btn btn-primary" onclick="recordAttendance()" style="padding: 15px 30px; font-size: 1.1em;">
                                    <i class="fas fa-save"></i> Save Attendance Records
                                </button>
                            </div>
                        </div>
                        
                        <div id="leaveRequestsSection" class="hidden" style="margin-top: 30px;">
                            <h3 style="color: white;">Pending Leave Requests</h3>
                            <div id="leaveRequestsList"></div>
                        </div>
                    </div>

                    <div id="teacherPerformance" class="teacher-section hidden">
                        <h2 class="section-title">Student Performance</h2>
                        <div class="form-group">
                            <label>Select Student</label>
                            <select id="performanceStudent" onchange="loadStudentPerformance()">
                                <option value="">Select a student</option>
                            </select>
                        </div>
                        <div id="performanceContent"></div>
                    </div>

                    <div id="teacherGrades" class="teacher-section hidden">
                        <h2 class="section-title">Upload Grades</h2>
                        <div class="form-group">
                            <label>Select Student</label>
                            <select id="gradeStudent">
                                <option value="">Select a student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Course</label>
                            <input type="text" id="gradeCourse" placeholder="Enter course name">
                        </div>
                        <div class="form-group">
                            <label>Assignment</label>
                            <select id="gradeAssignment">
                                <option value="">Select assignment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Grade</label>
                            <input type="text" id="studentGrade" placeholder="Enter grade (A, B, C, etc.)">
                        </div>
                        <div class="form-group">
                            <label>Semester</label>
                            <input type="text" id="gradeSemester" placeholder="Enter semester">
                        </div>
                        <button class="btn btn-primary" onclick="uploadGrade()">Upload Grade</button>
                    </div>

                    <div id="teacherAssignments" class="teacher-section hidden">
                        <h2 class="section-title">Upload Assignment</h2>
                        <div class="form-group">
                            <label>Assignment Title</label>
                            <input type="text" id="assignmentTitle" placeholder="Enter assignment title">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="assignmentDescription" placeholder="Enter assignment description"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="assignmentDueDate">
                        </div>
                        <div class="form-group">
                            <label>Course</label>
                            <select id="assignmentCourse">
                                <option value="">Select course</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Upload Assignment File</label>
                            <div class="file-upload" onclick="document.getElementById('assignmentFile').click()" style="border: 2px dashed rgba(255,255,255,0.3); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; color: white;">
                                <p><i class="fas fa-cloud-upload-alt"></i> Click to upload assignment file</p>
                                <input type="file" id="assignmentFile" class="hidden" multiple onchange="handleAssignmentFileUpload(this)">
                            </div>
                            <div id="assignmentFilesList" class="file-list"></div>
                        </div>
                        <button class="btn btn-primary" onclick="uploadAssignment()">Upload Assignment</button>
                    </div>

                    <div id="teacherSubmissions" class="teacher-section hidden">
                        <h2 class="section-title">Assignment Submissions</h2>
                        <div class="form-group">
                            <label>Select Assignment</label>
                            <select id="submissionAssignment" onchange="loadAssignmentSubmissions()">
                                <option value="">Select assignment</option>
                            </select>
                        </div>
                        <div id="submissionsContent"></div>
                    </div>

                    <div id="teacherTimetable" class="teacher-section hidden">
                        <h2 class="section-title">Upload Timetable</h2>
                        <div class="form-group">
                            <label>Department</label>
                            <select id="timetableDepartment">
                                <option value="computer_science">Computer Science</option>
                                <option value="electrical">Electrical Engineering</option>
                                <option value="mechanical">Mechanical Engineering</option>
                                <option value="civil">Civil Engineering</option>
                                <option value="business">Business Administration</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="timetableDescription" placeholder="e.g., Spring 2024 Timetable">
                        </div>
                        <div class="form-group">
                            <label>Upload Timetable Image</label>
                            <div class="file-upload" onclick="document.getElementById('timetableFile').click()" style="border: 2px dashed rgba(255,255,255,0.3); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; color: white;">
                                <p><i class="fas fa-cloud-upload-alt"></i> Click to upload timetable image (JPG, PNG)</p>
                                <input type="file" id="timetableFile" class="hidden" accept="image/*" onchange="previewTimetable(event)">
                            </div>
                            <img id="timetablePreview" class="timetable-image hidden" style="max-width: 100%; margin-top: 15px; border-radius: 10px;">
                        </div>
                        <button class="btn btn-primary" onclick="uploadTimetable()">Upload Timetable</button>
                    </div>

                    <div id="teacherForum" class="teacher-section hidden">
                        <h2 class="section-title">Discussion Forum</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="teacherForumCourseSelect" onchange="loadTeacherForumPosts()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <div id="teacherForumContent"></div>
                    </div>

                    <div id="teacherLiveMeet" class="teacher-section hidden">
                        <h2 class="section-title">Live Meetings</h2>
                        <div class="meeting-container">
                            <div class="meeting-controls">
                                <div class="form-group" style="flex: 1;">
                                    <label>Select Course</label>
                                    <select id="meetingCourse" onchange="loadCourseStudentsForMeeting()">
                                        <option value="">Select a course</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="startLiveMeeting()"><i class="fas fa-video"></i> Start Live Meeting</button>
                                <button class="btn btn-success" onclick="sendMeetingInvites()"><i class="fas fa-paper-plane"></i> Send Invites</button>
                            </div>
                            <div id="meetingRoom" class="hidden">
                                <h3 style="color: white;">Live Meeting Room</h3>
                                <div class="meet-iframe" id="meetIframe"></div>
                                <div class="online-students" id="onlineStudentsList"></div>
                            </div>
                            <div id="meetingInvites" class="hidden">
                                <h3 style="color: white;">Meeting Invitations Sent</h3>
                                <div id="invitedStudentsList"></div>
                            </div>
                        </div>
                    </div>

                    <div id="teacherPreviousPapers" class="teacher-section hidden">
                        <h2 class="section-title">Previous Question Papers</h2>
                        <div class="form-group">
                            <label>Paper Title</label>
                            <input type="text" id="paperTitle" placeholder="Enter paper title">
                        </div>
                        <div class="form-group">
                            <label>Subject</label>
                            <select id="paperSubjectTeacher">
                                <option value="mathematics">Mathematics</option>
                                <option value="physics">Physics</option>
                                <option value="programming">Programming</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Semester</label>
                            <input type="text" id="paperSemester" placeholder="e.g., Semester 1">
                        </div>
                        <div class="form-group">
                            <label>Year</label>
                            <input type="number" id="paperYear" placeholder="e.g., 2023">
                        </div>
                        <div class="form-group">
                            <label>Upload Paper</label>
                            <div class="file-upload" onclick="document.getElementById('paperFile').click()" style="border: 2px dashed rgba(255,255,255,0.3); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; color: white;">
                                <p><i class="fas fa-cloud-upload-alt"></i> Click to upload question paper</p>
                                <input type="file" id="paperFile" class="hidden" accept=".pdf,.doc,.docx" onchange="handlePaperUpload(this)">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="uploadPaper()">Upload Paper</button>
                    </div>

                    <div id="teacherSemesterResults" class="teacher-section hidden">
                        <h2 class="section-title">Semester Results</h2>
                        <div class="form-group">
                            <label>Select Course</label>
                            <select id="resultsCourse" onchange="loadCourseResults()">
                                <option value="">Select a course</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Semester</label>
                            <input type="text" id="resultsSemester" placeholder="e.g., Semester 1, 2024">
                        </div>
                        <button class="btn btn-primary" onclick="generateResultsTable()">Generate Results Table</button>
                        <div id="resultsTableContainer" class="hidden">
                            <h3 style="color: white;">Results for <span id="resultsCourseName"></span> - <span id="resultsSemesterName"></span></h3>
                            <div class="results-table-container">
                                <table class="results-table" style="width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255,255,255,0.9); border-radius: 10px; overflow: hidden;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 15px; text-align: left; background: var(--gradient-primary); color: white;">Student Name</th>
                                            <th style="padding: 15px; text-align: left; background: var(--gradient-primary); color: white;">Roll Number</th>
                                            <th style="padding: 15px; text-align: left; background: var(--gradient-primary); color: white;">Grade</th>
                                            <th style="padding: 15px; text-align: left; background: var(--gradient-primary); color: white;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody"></tbody>
                                </table>
                            </div>
                            <button class="btn btn-success" onclick="publishResults()" style="margin-top: 20px;"><i class="fas fa-share"></i> Publish Results</button>
                        </div>
                    </div>

                    <div id="teacherLeaderboard" class="teacher-section hidden">
                        <h2 class="section-title">üèÜ Monthly Student Leaderboard</h2>
                        <div class="leaderboard-container">
                            <div class="leaderboard-header">
                                <h3 class="leaderboard-title">Current Month Leaderboard</h3>
                                <button class="btn btn-primary" onclick="showCreateLeaderboardForm()">
                                    <i class="fas fa-plus"></i> Create New Leaderboard
                                </button>
                            </div>
                            
                            <div class="leaderboard-stats">
                                <div class="leaderboard-stat">
                                    <div class="stat-number" id="totalCreditsAwarded">0</div>
                                    <div class="stat-label">Total Credits Awarded</div>
                                </div>
                                <div class="leaderboard-stat">
                                    <div class="stat-number" id="activeStudents">0</div>
                                    <div class="stat-label">Active Students</div>
                                </div>
                                <div class="leaderboard-stat">
                                    <div class="stat-number" id="leaderboardCount">0</div>
                                    <div class="stat-label">Leaderboards Created</div>
                                </div>
                            </div>
                            
                            <div id="currentLeaderboard"></div>
                            <div id="leaderboardHistory"></div>
                            
                            <div id="createLeaderboardForm" class="hidden">
                                <h3 style="color: white; margin-bottom: 20px;">Create New Leaderboard</h3>
                                <div class="form-group">
                                    <label>Month</label>
                                    <select id="leaderboardMonth">
                                        <option value="January">January</option>
                                        <option value="February">February</option>
                                        <option value="March">March</option>
                                        <option value="April">April</option>
                                        <option value="May">May</option>
                                        <option value="June">June</option>
                                        <option value="July">July</option>
                                        <option value="August">August</option>
                                        <option value="September">September</option>
                                        <option value="October">October</option>
                                        <option value="November">November</option>
                                        <option value="December">December</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Year</label>
                                    <input type="number" id="leaderboardYear" value="2024" min="2020" max="2030">
                                </div>
                                
                                <h4 style="color: white; margin: 20px 0 15px 0;">Select Top 3 Students</h4>
                                <div id="topStudentsSelection">
                                    <!-- Will be populated with students -->
                                </div>
                                
                                <button class="btn btn-success" onclick="publishLeaderboard()" style="margin-top: 20px;">
                                    <i class="fas fa-trophy"></i> Publish Leaderboard
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="teacherComplaints" class="teacher-section hidden">
                        <h2 class="section-title">Student Complaints</h2>
                        <div id="complaintsList"></div>
                    </div>

                    <div id="teacherNotifications" class="teacher-section hidden">
                        <h2 class="section-title">Notifications</h2>
                        <div id="teacherNotificationsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parent Dashboard -->
        <div id="parentDashboard" class="hidden parent-portal">
            <div class="dashboard">
                <div class="sidebar">
                    <div class="profile-pic" id="parentProfilePic" style="position: relative;">
                        <i class="fas fa-users"></i>
                        <div id="parentNotificationBadge" class="notification-badge hidden">0</div>
                    </div>
                    <h3 id="parentName" style="text-align: center; margin-bottom: 20px; color: white;"></h3>
                    <ul class="sidebar-menu">
                        <li class="active" onclick="showParentSection('profile')"><i class="fas fa-user"></i> Profile</li>
                        <li onclick="showParentSection('studentInfo')"><i class="fas fa-user-graduate"></i> Student Information</li>
                        <li onclick="showParentSection('attendance')"><i class="fas fa-calendar-check"></i> Attendance</li>
                        <li onclick="showParentSection('results')"><i class="fas fa-chart-line"></i> Results</li>
                        <li onclick="showParentSection('timetable')"><i class="fas fa-calendar-alt"></i> Timetable</li>
                        <li onclick="showParentSection('performance')"><i class="fas fa-chart-bar"></i> Overall Performance</li>
                        <li onclick="showParentSection('leaderboard')"><i class="fas fa-trophy"></i> Student Leaderboard</li>
                        <li onclick="showParentSection('notifications')"><i class="fas fa-bell"></i> Notifications</li>
                        <li onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
                    </ul>
                    <div class="chat-option" onclick="toggleTeacherChat()" style="background: var(--gradient-purple); color: white; padding: 15px; border-radius: 12px; text-align: center; margin-top: 20px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-comments"></i> Parent-Teacher Chat
                    </div>
                </div>
                <div class="content">
                    <div id="parentProfile" class="parent-section">
                        <h2 class="section-title">Parent Profile</h2>
                        <div class="profile-header">
                            <div class="profile-pic" id="parentProfilePicLarge"><i class="fas fa-users"></i></div>
                            <h3 id="parentProfileName" style="color: white;"></h3>
                            <p id="parentProfileEmail" style="color: white;"></p>
                        </div>
                        <div class="grid">
                            <div class="feature-card" onclick="showParentSection('studentInfo')">
                                <div class="feature-icon"><i class="fas fa-user-graduate"></i></div>
                                <h3>Student Information</h3>
                                <p>View your child's academic details</p>
                            </div>
                            <div class="feature-card" onclick="showParentSection('attendance')">
                                <div class="feature-icon"><i class="fas fa-calendar-check"></i></div>
                                <h3>Attendance</h3>
                                <p>Monitor your child's attendance</p>
                            </div>
                            <div class="feature-card" onclick="showParentSection('results')">
                                <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                                <h3>Results</h3>
                                <p>Check your child's academic performance</p>
                            </div>
                            <div class="feature-card" onclick="showParentSection('timetable')">
                                <div class="feature-icon"><i class="fas fa-calendar-alt"></i></div>
                                <h3>Timetable</h3>
                                <p>View your child's class schedule</p>
                            </div>
                            <div class="feature-card" onclick="showParentSection('performance')">
                                <div class="feature-icon"><i class="fas fa-chart-bar"></i></div>
                                <h3>Overall Performance</h3>
                                <p>Comprehensive performance analytics</p>
                            </div>
                            <div class="feature-card" onclick="showParentSection('leaderboard')">
                                <div class="feature-icon"><i class="fas fa-trophy"></i></div>
                                <h3>Student Leaderboard</h3>
                                <p>Check your child's rankings</p>
                            </div>
                            <div class="feature-card" onclick="toggleTeacherChat()">
                                <div class="feature-icon"><i class="fas fa-comments"></i></div>
                                <h3>Teacher Chat</h3>
                                <p>Communicate with teachers</p>
                            </div>
                        </div>
                    </div>

                    <div id="parentStudentInfo" class="parent-section hidden">
                        <h2 class="section-title">Student Information</h2>
                        <div id="studentInfoContent"></div>
                    </div>

                    <div id="parentAttendance" class="parent-section hidden">
                        <h2 class="section-title">Student Attendance</h2>
                        <div id="parentAttendanceContent"></div>
                    </div>

                    <div id="parentResults" class="parent-section hidden">
                        <h2 class="section-title">Student Results</h2>
                        <div id="parentResultsContent"></div>
                    </div>

                    <div id="parentTimetable" class="parent-section hidden">
                        <h2 class="section-title">Student Timetable</h2>
                        <div id="parentTimetableContent"></div>
                    </div>

                    <div id="parentPerformance" class="parent-section hidden">
                        <h2 class="section-title">Overall Performance</h2>
                        <div class="performance-dashboard">
                            <div class="performance-card">
                                <h3 style="color: white;">Attendance Summary</h3>
                                <div id="parentAttendanceSummary"></div>
                            </div>
                            <div class="performance-card">
                                <h3 style="color: white;">Grade Distribution</h3>
                                <div id="parentGradeDistribution"></div>
                            </div>
                            <div class="performance-card" style="grid-column: span 2;">
                                <h3 style="color: white;">Performance Trends</h3>
                                <div id="parentPerformanceTrends"></div>
                            </div>
                        </div>
                    </div>

                    <div id="parentLeaderboard" class="parent-section hidden">
                        <h2 class="section-title">Student Leaderboard</h2>
                        <div id="parentLeaderboardContent"></div>
                    </div>

                    <div id="parentNotifications" class="parent-section hidden">
                        <h2 class="section-title">Notifications</h2>
                        <div id="parentNotificationsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chatbot -->
    <div id="chatbot" class="chatbot hidden">
        <div class="chatbot-header">
            <h3><i class="fas fa-robot"></i> AI Learning Assistant</h3>
            <button class="btn btn-purple btn-sm" onclick="toggleChatbot()"><i class="fas fa-times"></i></button>
        </div>
        <div class="chatbot-body" id="chatbotMessages">
            <div class="message bot-message" style="background: rgba(255,255,255,0.1); color: white; padding: 12px 18px; border-radius: 18px; margin-bottom: 15px;">
                Hello! I'm your AI learning assistant. I can help you with information about the portal, courses, assignments, attendance, and more. How can I assist you today?
            </div>
        </div>
        <div class="chatbot-input" style="display: flex; padding: 20px; border-top: 1px solid var(--glass-border); background: rgba(255,255,255,0.05);">
            <input type="text" id="chatbotInput" placeholder="Ask me anything about the portal..." style="flex: 1; margin-right: 10px; border-radius: 25px; padding: 12px 20px; background: rgba(255,255,255,0.9);">
            <button class="btn btn-primary" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <button class="btn btn-primary floating" onclick="toggleChatbot()" style="position: fixed; bottom: 20px; right: 20px; z-index: 999; border-radius: 50%; width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-robot"></i>
    </button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // All the JavaScript code remains exactly the same as in your original file
        // The entire script section is preserved without any changes
        let currentUser = null;
        let currentUserType = null;
        let courseFiles = [];
        let assignmentFiles = [];
        let socket = null;
        let selectedTeacher = null;
        let attendanceData = {};
        let onlineStudents = [];
        let activeMeeting = null;

        // Global variables for data storage
        let enrollments = [];
        let forumPosts = [];
        let notifications = [];
        let assignments = [];
        let courses = [];
        let timetables = [];
        let previousPapers = [];
        let semesterResults = [];

        // Initialize tab event listeners
        document.getElementById('studentTab').addEventListener('click', function() { showLoginForm('student'); });
        document.getElementById('teacherTab').addEventListener('click', function() { showLoginForm('teacher'); });
        document.getElementById('parentTab').addEventListener('click', function() { showLoginForm('parent'); });
        document.getElementById('registerTab').addEventListener('click', showRegisterForm);

        // Theme Management - FIXED
        function toggleThemeOptions() {
            const options = document.getElementById('themeOptions');
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }

        function changeTheme(theme) {
            document.body.className = `moving-bg theme-${theme}`;
            localStorage.setItem('eduportal-theme', theme);
            toggleThemeOptions();
        }

        // Load saved theme
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('eduportal-theme') || 'blue';
            changeTheme(savedTheme);
        }

        // Form visibility functions
        function showLoginForm(type) {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Activate the correct tab
            if (type === 'student') document.getElementById('studentTab').classList.add('active');
            if (type === 'teacher') document.getElementById('teacherTab').classList.add('active');
            if (type === 'parent') document.getElementById('parentTab').classList.add('active');
            
            const titleMap = {
                'student': 'Student Login',
                'teacher': 'Teacher Login',
                'parent': 'Parent Login'
            };
            document.getElementById('loginTitle').textContent = titleMap[type] || 'Login';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('registerTab').classList.add('active');
            toggleRegisterFields();
        }

        function toggleRegisterFields() {
            const type = document.getElementById('registerType').value;
            if (type === 'student') {
                document.getElementById('studentFields').classList.remove('hidden');
                document.getElementById('teacherFields').classList.add('hidden');
            } else {
                document.getElementById('studentFields').classList.add('hidden');
                document.getElementById('teacherFields').classList.remove('hidden');
            }
        }

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('photoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.querySelector('.photo-upload p').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        function previewTimetable(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('timetablePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        // Authentication functions - FIXED
        async function register() {
            try {
                const type = document.getElementById('registerType').value;
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const department = document.getElementById('registerDepartment').value;
                
                if (!name || !email || !password) {
                    alert('Please fill in all required fields');
                    return;
                }

                const formData = new FormData();
                formData.append('type', type);
                formData.append('name', name);
                formData.append('email', email);
                formData.append('password', password);
                formData.append('department', department);
                
                const photoInput = document.getElementById('registerPhoto');
                if (photoInput.files[0]) {
                    formData.append('photo', photoInput.files[0]);
                }
                
                if (type === 'student') {
                    formData.append('fatherName', document.getElementById('registerFatherName').value);
                    formData.append('rollNumber', document.getElementById('registerRollNumber').value);
                    formData.append('parentEmail', document.getElementById('registerParentEmail').value);
                    formData.append('parentPassword', document.getElementById('registerParentPassword').value);
                } else {
                    formData.append('subject', document.getElementById('registerSubject').value);
                }

                const response = await fetch('/api/register', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    showLoginForm(type);
                }
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        async function login() {
            try {
                const loginData = {
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value
                };

                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });

                const result = await response.json();
                if (result.success) {
                    currentUser = result.user;
                    currentUserType = result.user.type;
                    showDashboard();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            
            // Initialize socket connection
            socket = io();
            socket.emit('join-user', currentUser.email);
            
            socket.on('notification', (notification) => {
                updateNotificationBadge();
                if (currentUserType === 'student') {
                    loadStudentNotifications();
                } else if (currentUserType === 'teacher') {
                    loadTeacherNotifications();
                } else if (currentUserType === 'parent') {
                    loadParentNotifications();
                }
            });

            socket.on('meeting-invitation', (data) => {
                if (currentUserType === 'student') {
                    showMeetingInvitation(data);
                }
            });

            socket.on('user-online', (data) => {
                if (currentUserType === 'teacher' && data.userType === 'student') {
                    updateOnlineStudents(data);
                }
            });

            socket.on('user-offline', (data) => {
                if (currentUserType === 'teacher' && data.userType === 'student') {
                    removeOnlineStudent(data.email);
                }
            });

            if (currentUserType === 'student') {
                document.getElementById('studentDashboard').classList.remove('hidden');
                loadStudentProfile();
                updateNotificationBadge();
                loadStudentNotifications();
                // Notify teacher that student is online
                socket.emit('user-online', {
                    email: currentUser.email,
                    name: currentUser.name,
                    userType: 'student'
                });
            } else if (currentUserType === 'teacher') {
                document.getElementById('teacherDashboard').classList.remove('hidden');
                loadTeacherProfile();
                loadTeacherStudents();
                loadTeacherComplaints();
                updateNotificationBadge();
                loadTeacherNotifications();
                loadTeacherCourses();
                loadTeacherAssignments();
                loadTeacherLeaderboard();
            } else if (currentUserType === 'parent') {
                document.getElementById('parentDashboard').classList.remove('hidden');
                loadParentProfile();
                updateNotificationBadge();
                loadParentNotifications();
                loadParentTeachers();
            }
        }

        function logout() {
            if (currentUserType === 'student') {
                socket.emit('user-offline', {
                    email: currentUser.email,
                    userType: 'student'
                });
            }
            
            currentUser = null;
            currentUserType = null;
            if (socket) {
                socket.disconnect();
            }
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('teacherDashboard').classList.add('hidden');
            document.getElementById('parentDashboard').classList.add('hidden');
        }

        // Student functions
        function loadStudentProfile() {
            document.getElementById('studentName').textContent = currentUser.name;
            const profilePic = document.getElementById('studentProfilePic');
            const profilePicLarge = document.getElementById('studentProfilePicLarge');
            
            if (currentUser.photo) {
                profilePic.style.backgroundImage = `url(${currentUser.photo})`;
                profilePic.textContent = '';
                profilePicLarge.style.backgroundImage = `url(${currentUser.photo})`;
                profilePicLarge.textContent = '';
            } else {
                profilePic.textContent = currentUser.name.charAt(0);
                profilePicLarge.textContent = currentUser.name.charAt(0);
            }
            
            document.getElementById('studentProfileName').textContent = currentUser.name;
            document.getElementById('studentProfileEmail').textContent = currentUser.email;
            document.getElementById('studentProfileDepartment').textContent = "Department: " + currentUser.department.replace('_', ' ').toUpperCase();
            document.getElementById('studentProfileRollNumber').textContent = "Roll Number: " + currentUser.rollNumber;

            // Load stats
            loadStudentStats();
        }

        async function loadStudentStats() {
            try {
                // Load enrolled courses count
                const coursesResponse = await fetch(`/api/enrolled-courses/${currentUser.email}`);
                const coursesResult = await coursesResponse.json();
                if (coursesResult.success) {
                    document.getElementById('studentCoursesCount').textContent = coursesResult.courses.length;
                }

                // Load attendance percentage
                const attendanceResponse = await fetch(`/api/attendance/${currentUser.email}`);
                const attendanceResult = await attendanceResponse.json();
                if (attendanceResult.success && attendanceResult.attendance.length > 0) {
                    const presentCount = attendanceResult.attendance.filter(a => a.status === 'present').length;
                    const totalCount = attendanceResult.attendance.length;
                    const percentage = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;
                    document.getElementById('studentAttendancePercent').textContent = percentage + '%';
                }

                // Load assignments count
                const assignmentsResponse = await fetch(`/api/assignments/${currentUser.department}`);
                const assignmentsResult = await assignmentsResponse.json();
                if (assignmentsResult.success) {
                    document.getElementById('studentAssignmentsCount').textContent = assignmentsResult.assignments.length;
                }

                // Load credits
                const creditsResponse = await fetch(`/api/student/credits/${currentUser.email}`);
                const creditsResult = await creditsResponse.json();
                if (creditsResult.success) {
                    document.getElementById('studentCreditsCount').textContent = creditsResult.credits;
                }
            } catch (error) {
                console.error('Error loading student stats:', error);
            }
        }

        function showStudentSection(section) {
            document.querySelectorAll('.student-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById('student' + section.charAt(0).toUpperCase() + section.slice(1)).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            event.target.classList.add('active');

            if (section === 'courses') loadAvailableCourses();
            if (section === 'myCourses') loadEnrolledCourses();
            if (section === 'attendance') loadStudentAttendance();
            if (section === 'results') loadStudentResults();
            if (section === 'assignments') loadStudentAssignments();
            if (section === 'timetable') loadStudentTimetable();
            if (section === 'forum') loadStudentForum();
            if (section === 'previousPapers') loadPreviousPapers();
            if (section === 'liveMeet') loadStudentLiveMeetings();
            if (section === 'leaderboard') loadStudentLeaderboard();
            if (section === 'notifications') loadStudentNotifications();
        }

        async function loadAvailableCourses() {
            try {
                const response = await fetch('/api/all-courses');
                const result = await response.json();
                
                let html = '<div class="grid">';
                if (result.success && result.courses.length > 0) {
                    // Get enrolled courses
                    const enrolledResponse = await fetch(`/api/enrolled-courses/${currentUser.email}`);
                    const enrolledResult = await enrolledResponse.json();
                    const enrolledCourseIds = enrolledResult.success ? enrolledResult.courses.map(c => c.id) : [];
                    
                    result.courses.forEach(course => {
                        const isEnrolled = enrolledCourseIds.includes(course.id);
                        
                        html += `
                            <div class="course-card feature-card">
                                <h3>${course.courseName}</h3>
                                <p><strong>Teacher:</strong> ${course.teacherEmail}</p>
                                <p><strong>Duration:</strong> ${course.duration}</p>
                                <p>${course.description}</p>
                                ${isEnrolled ? 
                                    '<span class="enrollment-status">Enrolled</span>' :
                                    `<button class="btn btn-primary" onclick="enrollInCourse('${course.id}')">Enroll</button>`
                                }
                            </div>
                        `;
                    });
                } else {
                    html += '<p>No courses available at the moment.</p>';
                }
                html += '</div>';
                document.getElementById('availableCoursesContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading available courses:', error);
                document.getElementById('availableCoursesContent').innerHTML = '<p>Error loading courses</p>';
            }
        }

        async function enrollInCourse(courseId) {
            try {
                const response = await fetch('/api/enroll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentEmail: currentUser.email,
                        courseId: courseId
                    })
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    loadAvailableCourses();
                    loadEnrolledCourses();
                    loadStudentStats();
                }
            } catch (error) {
                alert('Enrollment failed: ' + error.message);
            }
        }

        async function loadEnrolledCourses() {
            try {
                const response = await fetch(`/api/enrolled-courses/${currentUser.email}`);
                const result = await response.json();
                
                let html = '<div class="grid">';
                if (result.success && result.courses.length > 0) {
                    result.courses.forEach(course => {
                        // Load video resources for the course
                        const videoResources = getCourseVideos(course.courseName);
                        
                        html += `
                            <div class="course-card feature-card">
                                <h3>${course.courseName}</h3>
                                <p><strong>Teacher:</strong> ${course.teacherEmail}</p>
                                <p><strong>Duration:</strong> ${course.duration}</p>
                                <p>${course.description}</p>
                                <p><strong>Enrolled on:</strong> ${new Date(course.enrolledDate).toLocaleDateString()}</p>
                                <div class="file-list">
                                    ${course.files && course.files.length > 0 ? 
                                        course.files.map(file => `
                                            <div class="file-item">
                                                <div class="file-info">
                                                    <span class="file-icon">üìÑ</span>
                                                    <span>${file.name}</span>
                                                </div>
                                                <button class="btn btn-primary btn-sm" onclick="downloadFile('${file.url}', '${file.name}')">Download</button>
                                            </div>
                                        `).join('') : 
                                        '<p>No course materials available.</p>'
                                    }
                                </div>
                                ${videoResources.length > 0 ? `
                                    <div class="video-resources">
                                        <h4>Video Resources</h4>
                                        ${videoResources.map(video => `
                                            <div class="video-card">
                                                <div class="video-thumbnail">
                                                    <i class="fas fa-play-circle"></i>
                                                </div>
                                                <div class="video-info">
                                                    <h5>${video.title}</h5>
                                                    <p>${video.description}</p>
                                                    <button class="btn btn-primary btn-sm" onclick="playVideo('${video.url}')">Watch Video</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += '<p>You are not enrolled in any courses yet.</p>';
                }
                html += '</div>';
                document.getElementById('enrolledCoursesContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading enrolled courses:', error);
                document.getElementById('enrolledCoursesContent').innerHTML = '<p>Error loading enrolled courses</p>';
            }
        }

        function getCourseVideos(courseName) {
            // In a real application, this would fetch from the server
            const videoData = {
                'Introduction to Programming': [
                    {
                        title: 'Python Basics',
                        description: 'Learn the fundamentals of Python programming',
                        url: 'https://www.youtube.com/embed/rfscVS0vtbw'
                    },
                    {
                        title: 'Data Types and Variables',
                        description: 'Understanding different data types in Python',
                        url: 'https://www.youtube.com/embed/khKv-8q7YmY'
                    }
                ],
                'Data Structures': [
                    {
                        title: 'Arrays and Lists',
                        description: 'Introduction to arrays and linked lists',
                        url: 'https://www.youtube.com/embed/RBSGKlAvoiM'
                    }
                ]
            };
            
            return videoData[courseName] || [];
        }

        function playVideo(url) {
            const videoModal = document.createElement('div');
            videoModal.style.position = 'fixed';
            videoModal.style.top = '0';
            videoModal.style.left = '0';
            videoModal.style.width = '100%';
            videoModal.style.height = '100%';
            videoModal.style.backgroundColor = 'rgba(0,0,0,0.8)';
            videoModal.style.zIndex = '10000';
            videoModal.style.display = 'flex';
            videoModal.style.alignItems = 'center';
            videoModal.style.justifyContent = 'center';
            
            videoModal.innerHTML = `
                <div style="position: relative; width: 80%; max-width: 800px;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: red; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Close</button>
                    <iframe width="100%" height="400" src="${url}" frameborder="0" allowfullscreen></iframe>
                </div>
            `;
            
            document.body.appendChild(videoModal);
        }

        async function loadStudentAttendance() {
            try {
                const response = await fetch(`/api/attendance/${currentUser.email}`);
                const result = await response.json();
                
                if (result.success) {
                    const graph = document.getElementById('attendanceGraph');
                    const subjectGraph = document.getElementById('subjectAttendanceGraph');
                    graph.innerHTML = '';
                    subjectGraph.innerHTML = '';
                    
                    // Group by course
                    const courseData = {};
                    
                    result.attendance.forEach(record => {
                        if (!courseData[record.course]) {
                            courseData[record.course] = { present: 0, total: 0 };
                        }
                        courseData[record.course].total++;
                        if (record.status === 'present') courseData[record.course].present++;
                    });

                    // Overall attendance
                    let totalPresent = 0;
                    let totalClasses = 0;
                    
                    for (const [course, data] of Object.entries(courseData)) {
                        totalPresent += data.present;
                        totalClasses += data.total;
                        const percentage = (data.present / data.total) * 100;
                        const bar = document.createElement('div');
                        bar.className = 'graph-bar';
                        bar.style.width = `${percentage}%`;
                        bar.textContent = `${course}: ${percentage.toFixed(1)}% (${data.present}/${data.total})`;
                        graph.appendChild(bar);
                    }

                    // Subject-wise attendance
                    for (const [course, data] of Object.entries(courseData)) {
                        const percentage = (data.present / data.total) * 100;
                        const bar = document.createElement('div');
                        bar.className = 'graph-bar';
                        bar.style.width = `${percentage}%`;
                        bar.textContent = `${course}: ${percentage.toFixed(1)}% (${data.present}/${data.total})`;
                        subjectGraph.appendChild(bar);
                    }
                } else {
                    document.getElementById('attendanceGraph').innerHTML = '<p>No attendance records found.</p>';
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('attendanceGraph').innerHTML = '<p>Error loading attendance records</p>';
            }
        }

        async function loadStudentResults() {
            try {
                const [gradesResponse, overallResponse] = await Promise.all([
                    fetch(`/api/grades/${currentUser.email}`),
                    fetch(`/api/overall-grades/${currentUser.email}`)
                ]);
                
                const gradesResult = await gradesResponse.json();
                const overallResult = await overallResponse.json();
                
                let html = '<div class="grid">';
                if (gradesResult.success && gradesResult.grades.length > 0) {
                    gradesResult.grades.forEach(grade => {
                        html += `
                            <div class="feature-card">
                                <h3>${grade.course}</h3>
                                <p>Grade: ${grade.grade}</p>
                                <p>Semester: ${grade.semester}</p>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>No grades available yet.</p>';
                }
                html += '</div>';
                document.getElementById('resultsContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('resultsContent').innerHTML = '<p>Error loading results</p>';
            }
        }

        async function loadStudentAssignments() {
            try {
                const response = await fetch(`/api/assignments/${currentUser.department}`);
                const result = await response.json();
                
                let html = '<div class="grid">';
                if (result.success && result.assignments.length > 0) {
                    result.assignments.forEach(assignment => {
                        let filesHtml = '';
                        if (assignment.files && assignment.files.length > 0) {
                            filesHtml = '<div class="file-list">';
                            assignment.files.forEach(file => {
                                filesHtml += `
                                    <div class="file-item">
                                        <div class="file-info">
                                            <span class="file-icon">üìÑ</span>
                                            <span>${file.name}</span>
                                        </div>
                                        <button class="btn btn-primary btn-sm" onclick="downloadFile('${file.url}', '${file.name}')">Download</button>
                                    </div>
                                `;
                            });
                            filesHtml += '</div>';
                        }
                        
                        html += `
                            <div class="feature-card">
                                <h3>${assignment.title}</h3>
                                <p>${assignment.description}</p>
                                <p><strong>Due:</strong> ${new Date(assignment.dueDate).toLocaleDateString()}</p>
                                ${filesHtml}
                                <div class="form-group" style="margin-top: 15px;">
                                    <label>Submit Your Work</label>
                                    <input type="file" id="assignmentSubmission${assignment.id}">
                                    <button class="btn btn-success" onclick="submitAssignment('${assignment.id}')" style="margin-top: 10px;">Submit</button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>No assignments available.</p>';
                }
                html += '</div>';
                document.getElementById('assignmentsContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('assignmentsContent').innerHTML = '<p>Error loading assignments</p>';
            }
        }

        async function submitAssignment(assignmentId) {
            const fileInput = document.getElementById(`assignmentSubmission${assignmentId}`);
            if (fileInput.files.length === 0) {
                alert('Please select a file to submit');
                return;
            }

            const formData = new FormData();
            formData.append('assignmentId', assignmentId);
            formData.append('studentEmail', currentUser.email);
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/submit-assignment', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    fileInput.value = '';
                }
            } catch (error) {
                alert('Assignment submission failed: ' + error.message);
            }
        }

        async function loadStudentTimetable() {
            try {
                const response = await fetch(`/api/timetable/${currentUser.department}`);
                const result = await response.json();
                
                let html = '';
                if (result.success && result.timetable) {
                    html = `
                        <h3>${result.timetable.description}</h3>
                        <p><strong>Uploaded by:</strong> ${result.timetable.teacherEmail}</p>
                        <p><strong>Date:</strong> ${new Date(result.timetable.uploadedDate).toLocaleDateString()}</p>
                        ${result.timetable.image ? `<img src="${result.timetable.image}" alt="Timetable" class="timetable-image">` : '<p>No timetable image available.</p>'}
                    `;
                } else {
                    html = '<p>No timetable available for your department.</p>';
                }
                document.getElementById('timetableContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading timetable:', error);
                document.getElementById('timetableContent').innerHTML = '<p>Error loading timetable</p>';
            }
        }

        async function loadStudentForum() {
            try {
                const response = await fetch(`/api/enrolled-courses/${currentUser.email}`);
                const result = await response.json();
                
                const courseSelect = document.getElementById('forumCourseSelect');
                courseSelect.innerHTML = '<option value="">Select a course</option>';
                
                if (result.success && result.courses.length > 0) {
                    result.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.courseName;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading forum courses:', error);
            }
        }

        async function loadForumPosts() {
            const courseId = document.getElementById('forumCourseSelect').value;
            if (!courseId) return;

            try {
                const response = await fetch(`/api/forum-posts/${courseId}`);
                const result = await response.json();
                
                let html = '';
                if (result.success && result.posts.length > 0) {
                    result.posts.forEach(post => {
                        html += `
                            <div class="forum-post feature-card">
                                <h4>${post.title}</h4>
                                <p><strong>By:</strong> ${post.userEmail}</p>
                                <p>${post.content}</p>
                                <p><small>Posted: ${new Date(post.createdDate).toLocaleString()}</small></p>
                                
                                <div class="forum-replies">
                                    <h5>Replies (${post.replies.length}):</h5>
                                    ${post.replies.map(reply => `
                                        <div class="forum-reply">
                                            <p><strong>${reply.userEmail}:</strong> ${reply.content}</p>
                                            <p><small>${new Date(reply.createdDate).toLocaleString()}</small></p>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <textarea id="replyContent${post.id}" placeholder="Write your reply..."></textarea>
                                    <button class="btn btn-primary" onclick="postReply('${post.id}')">Post Reply</button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>No discussions yet. Start the first one!</p>';
                }
                
                html += `
                    <div class="forum-post feature-card">
                        <h4>Start New Discussion</h4>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="newPostTitle" placeholder="Enter discussion title">
                        </div>
                        <div class="form-group">
                            <label>Content</label>
                            <textarea id="newPostContent" placeholder="Write your discussion content..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="createForumPost('${courseId}')">Create Post</button>
                    </div>
                `;
                
                document.getElementById('forumContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading forum posts:', error);
                document.getElementById('forumContent').innerHTML = '<p>Error loading forum posts</p>';
            }
        }

        async function createForumPost(courseId) {
            const title = document.getElementById('newPostTitle').value;
            const content = document.getElementById('newPostContent').value;
            
            if (!title || !content) {
                alert('Please fill in both title and content');
                return;
            }

            try {
                const response = await fetch('/api/forum-posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userEmail: currentUser.email,
                        courseId: courseId,
                        title: title,
                        content: content
                    })
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    loadForumPosts();
                }
            } catch (error) {
                alert('Forum post creation failed: ' + error.message);
            }
        }

        async function postReply(postId) {
            const content = document.getElementById(`replyContent${postId}`).value;
            
            if (!content) {
                alert('Please write a reply');
                return;
            }

            try {
                const response = await fetch('/api/forum-replies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postId: postId,
                        userEmail: currentUser.email,
                        content: content
                    })
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    loadForumPosts();
                }
            } catch (error) {
                alert('Reply posting failed: ' + error.message);
            }
        }

        async function submitLeaveRequest() {
            const leaveData = {
                userEmail: currentUser.email,
                type: currentUserType,
                startDate: document.getElementById('leaveStartDate').value,
                endDate: document.getElementById('leaveEndDate').value,
                reason: document.getElementById('leaveReason').value
            };

            try {
                const response = await fetch('/api/leave', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(leaveData)
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    document.getElementById('leaveStartDate').value = '';
                    document.getElementById('leaveEndDate').value = '';
                    document.getElementById('leaveReason').value = '';
                }
            } catch (error) {
                alert('Leave request failed: ' + error.message);
            }
        }

        async function loadPreviousPapers() {
            const subject = document.getElementById('paperSubject').value;
            
            try {
                const response = await fetch('/api/previous-papers');
                const result = await response.json();
                
                let html = '';
                if (result.success && result.papers.length > 0) {
                    const filteredPapers = subject === 'all' ? 
                        result.papers : 
                        result.papers.filter(paper => paper.subject === subject);
                    
                    if (filteredPapers.length > 0) {
                        filteredPapers.forEach(paper => {
                            html += `
                                <div class="paper-card feature-card">
                                    <h3>${paper.title}</h3>
                                    <p><strong>Subject:</strong> ${paper.subject}</p>
                                    <p><strong>Semester:</strong> ${paper.semester}</p>
                                    <p><strong>Year:</strong> ${paper.year}</p>
                                    <p><strong>Uploaded by:</strong> ${paper.teacherEmail}</p>
                                    <button class="btn btn-primary" onclick="downloadFile('${paper.file.url}', '${paper.file.name}')">Download Paper</button>
                                </div>
                            `;
                        });
                    } else {
                        html = '<p>No papers available for the selected subject.</p>';
                    }
                } else {
                    html = '<p>No previous papers available.</p>';
                }
                document.getElementById('previousPapersContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading previous papers:', error);
                document.getElementById('previousPapersContent').innerHTML = '<p>Error loading papers</p>';
            }
        }

        function loadStudentLiveMeetings() {
            let html = `
                <div class="meeting-container">
                    <h3>Live Meeting Invitations</h3>
                    <div id="meetingInvitationsList"></div>
                </div>
            `;
            document.getElementById('liveMeetContent').innerHTML = html;
            
            // Load any active meeting invitations
            loadMeetingInvitations();
        }

        function loadMeetingInvitations() {
            // In a real application, this would fetch from the server
            const invitations = [
                {
                    id: 1,
                    course: 'Introduction to Programming',
                    teacher: 'Dr. Sarah Johnson',
                    meetingUrl: 'https://meet.google.com/abc-def-ghi',
                    scheduledTime: new Date(Date.now() + 30 * 60 * 1000) // 30 minutes from now
                }
            ];
            
            let html = '';
            if (invitations.length > 0) {
                invitations.forEach(invite => {
                    html += `
                        <div class="feature-card">
                            <h3>${invite.course}</h3>
                            <p><strong>Teacher:</strong> ${invite.teacher}</p>
                            <p><strong>Scheduled:</strong> ${invite.scheduledTime.toLocaleString()}</p>
                            <button class="btn btn-primary" onclick="joinMeeting('${invite.meetingUrl}')">Join Meeting</button>
                        </div>
                    `;
                });
            } else {
                html = '<p>No active meeting invitations.</p>';
            }
            document.getElementById('meetingInvitationsList').innerHTML = html;
        }

        function showMeetingInvitation(data) {
            // Show notification for new meeting invitation
            alert(`New meeting invitation for ${data.course} from ${data.teacher}`);
            // Refresh the meetings list
            loadMeetingInvitations();
        }

        function joinMeeting(url) {
            window.open(url, '_blank');
        }

        async function submitComplaint() {
            const complaintData = {
                studentEmail: currentUser.email,
                title: document.getElementById('complaintTitle').value,
                description: document.getElementById('complaintDescription').value,
                category: document.getElementById('complaintCategory').value
            };

            try {
                const response = await fetch('/api/complaint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(complaintData)
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    document.getElementById('complaintTitle').value = '';
                    document.getElementById('complaintDescription').value = '';
                }
            } catch (error) {
                alert('Complaint submission failed: ' + error.message);
            }
        }

        // Leaderboard Functions for Students
        async function loadStudentLeaderboard() {
            try {
                const [leaderboardResponse, creditsResponse, topStudentsResponse] = await Promise.all([
                    fetch('/api/leaderboard/current'),
                    fetch(`/api/student/credits/${currentUser.email}`),
                    fetch(`/api/top-students/${currentUser.department}`)
                ]);
                
                const leaderboardResult = await leaderboardResponse.json();
                const creditsResult = await creditsResponse.json();
                const topStudentsResult = await topStudentsResponse.json();
                
                // Update student credits
                if (creditsResult.success) {
                    document.getElementById('studentCredits').textContent = `${creditsResult.credits} Credits`;
                }
                
                let leaderboardHtml = '';
                if (leaderboardResult.success && leaderboardResult.leaderboard) {
                    const leaderboard = leaderboardResult.leaderboard;
                    const isOnLeaderboard = leaderboard.topStudents.some(student => student.email === currentUser.email);
                    
                    leaderboardHtml = `
                        <h3 style="color: white; margin-bottom: 20px;">${leaderboard.month} ${leaderboard.year} Leaderboard</h3>
                        ${isOnLeaderboard ? `
                            <div class="feature-card" style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1)); border-color: #ffd700; text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">üéâ</div>
                                <h3 style="color: #ffd700;">Congratulations!</h3>
                                <p style="color: white;">You are on this month's leaderboard!</p>
                            </div>
                        ` : ''}
                        <div class="leaderboard-winners">
                            ${leaderboard.topStudents.map((student, index) => `
                                <div class="winner-card ${index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze'} ${student.email === currentUser.email ? 'current-user' : ''}">
                                    <div class="winner-position">#${student.position}</div>
                                    <div class="winner-medal">
                                        ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                                    </div>
                                    <div class="winner-name">${student.name} ${student.email === currentUser.email ? ' (You)' : ''}</div>
                                    <div class="winner-credits">+${student.credits} Credits</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    leaderboardHtml = '<p style="color: white; text-align: center;">No leaderboard available for current month.</p>';
                }
                document.getElementById('studentLeaderboardContent').innerHTML = leaderboardHtml;
                
                // Display top students ranking
                let statsHtml = '';
                if (topStudentsResult.success && topStudentsResult.students.length > 0) {
                    statsHtml = `
                        <h3 style="color: white; margin: 30px 0 15px 0;">Department Rankings</h3>
                        <div class="feature-card">
                            <div style="display: grid; gap: 10px;">
                                ${topStudentsResult.students.map((student, index) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${student.email === currentUser.email ? 'rgba(52, 152, 219, 0.2)' : 'rgba(255,255,255,0.05)'}; border-radius: 8px; border: ${student.email === currentUser.email ? '1px solid #3498db' : '1px solid rgba(255,255,255,0.1)'}">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="font-weight: 600; color: white;">#${index + 1}</div>
                                            <div>
                                                <div style="font-weight: 600; color: white;">${student.name} ${student.email === currentUser.email ? ' (You)' : ''}</div>
                                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">${student.rollNumber}</div>
                                            </div>
                                        </div>
                                        <div class="credits-badge">${student.performanceCredits || 0} Credits</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                document.getElementById('studentPerformanceStats').innerHTML = statsHtml;
                
            } catch (error) {
                console.error('Error loading student leaderboard:', error);
            }
        }

        async function loadStudentNotifications() {
            try {
                const response = await fetch(`/api/notifications/${currentUser.email}`);
                const result = await response.json();
                
                let html = '';
                if (result.success && result.notifications.length > 0) {
                    result.notifications.forEach(notification => {
                        html += `
                            <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="markNotificationAsRead('${notification.id}')">
                                <h4>${notification.title}</h4>
                                <p>${notification.message}</p>
                                <p><small>${new Date(notification.timestamp).toLocaleString()}</small></p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>No notifications.</p>';
                }
                document.getElementById('notificationsContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('notificationsContent').innerHTML = '<p>Error loading notifications</p>';
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notificationId })
                });

                const result = await response.json();
                if (result.success) {
                    updateNotificationBadge();
                    loadStudentNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Teacher functions
        function loadTeacherProfile() {
            document.getElementById('teacherName').textContent = currentUser.name;
            const profilePic = document.getElementById('teacherProfilePic');
            const profilePicLarge = document.getElementById('teacherProfilePicLarge');
            
            if (currentUser.photo) {
                profilePic.style.backgroundImage = `url(${currentUser.photo})`;
                profilePic.textContent = '';
                profilePicLarge.style.backgroundImage = `url(${currentUser.photo})`;
                profilePicLarge.textContent = '';
            } else {
                profilePic.textContent = currentUser.name.charAt(0);
                profilePicLarge.textContent = currentUser.name.charAt(0);
            }
            
            document.getElementById('teacherProfileName').textContent = currentUser.name;
            document.getElementById('teacherProfileEmail').textContent = currentUser.email;
            document.getElementById('teacherProfileDepartment').textContent = "Department: " + currentUser.department.replace('_', ' ').toUpperCase();
            document.getElementById('teacherProfileSubject').textContent = "Subject: " + (currentUser.subject || 'N/A');

            // Load teacher stats
            loadTeacherStats();
        }

        async function loadTeacherStats() {
            try {
                // Load courses count
                const coursesResponse = await fetch(`/api/courses/${currentUser.department}`);
                const coursesResult = await coursesResponse.json();
                if (coursesResult.success) {
                    const teacherCourses = coursesResult.courses.filter(course => course.teacherEmail === currentUser.email);
                    document.getElementById('teacherCoursesCount').textContent = teacherCourses.length;
                }

                // Load students count
                const studentsResponse = await fetch(`/api/students/${currentUser.department}`);
                const studentsResult = await studentsResponse.json();
                if (studentsResult.success) {
                    document.getElementById('teacherStudentsCount').textContent = studentsResult.students.length;
                }

                // Load assignments count
                const assignmentsResponse = await fetch(`/api/assignments/${currentUser.department}`);
                const assignmentsResult = await assignmentsResponse.json();
                if (assignmentsResult.success) {
                    const teacherAssignments = assignmentsResult.assignments.filter(assignment => assignment.teacherEmail === currentUser.email);
                    document.getElementById('teacherAssignmentsCount').textContent = teacherAssignments.length;
                }

                // Load leaderboards count
                const leaderboardsResponse = await fetch('/api/leaderboard/history');
                const leaderboardsResult = await leaderboardsResponse.json();
                if (leaderboardsResult.success) {
                    const teacherLeaderboards = leaderboardsResult.leaderboards.filter(lb => lb.teacherEmail === currentUser.email);
                    document.getElementById('teacherLeaderboardsCount').textContent = teacherLeaderboards.length;
                }
            } catch (error) {
                console.error('Error loading teacher stats:', error);
            }
        }

        async function loadTeacherStudents() {
            try {
                const response = await fetch(`/api/students/${currentUser.department}`);
                const result = await response.json();
                
                if (result.success) {
                    const studentSelects = document.querySelectorAll('select[id$="Student"]');
                    studentSelects.forEach(select => {
                        select.innerHTML = '<option value="">Select a student</option>';
                        result.students.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.email;
                            option.textContent = `${student.name} (${student.rollNumber})`;
                            select.appendChild(option);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading teacher students:', error);
            }
        }

        async function loadTeacherComplaints() {
            try {
                const response = await fetch(`/api/complaints/${currentUser.department}`);
                const result = await response.json();
                
                if (result.success) {
                    const complaintsList = document.getElementById('complaintsList');
                    complaintsList.innerHTML = '';
                    
                    if (result.complaints.length > 0) {
                        result.complaints.forEach(complaint => {
                            const complaintItem = document.createElement('div');
                            complaintItem.className = 'complaint-item feature-card';
                            complaintItem.innerHTML = `
                                <div class="complaint-header">
                                    <h4>${complaint.title}</h4>
                                    <div>
                                        <span class="complaint-category">${complaint.category}</span>
                                        <span class="complaint-status status-${complaint.status}">${complaint.status}</span>
                                    </div>
                                </div>
                                <p><strong>Student:</strong> ${complaint.studentEmail}</p>
                                <p>${complaint.description}</p>
                                <p><small>Submitted: ${new Date(complaint.submittedDate).toLocaleDateString()}</small></p>
                                <div class="form-group" style="margin-top: 10px;">
                                    <label>Update Status</label>
                                    <select id="status-${complaint.id}" onchange="updateComplaintStatus('${complaint.id}')">
                                        <option value="open" ${complaint.status === 'open' ? 'selected' : ''}>Open</option>
                                        <option value="in-progress" ${complaint.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="resolved" ${complaint.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                    </select>
                                </div>
                            `;
                            complaintsList.appendChild(complaintItem);
                        });
                    } else {
                        complaintsList.innerHTML = '<p>No complaints found.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading teacher complaints:', error);
            }
        }

        async function updateComplaintStatus(complaintId) {
            const status = document.getElementById(`status-${complaintId}`).value;
            
            try {
                const response = await fetch('/api/complaint-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ complaintId, status })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Complaint status updated successfully');
                }
            } catch (error) {
                alert('Complaint status update failed: ' + error.message);
            }
        }

        function showTeacherSection(section) {
            document.querySelectorAll('.teacher-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById('teacher' + section.charAt(0).toUpperCase() + section.slice(1)).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            event.target.classList.add('active');

            if (section === 'attendance') {
                loadLeaveRequests();
                loadTeacherCoursesForAttendance();
            }
            if (section === 'performance') loadTeacherStudents();
            if (section === 'myCourses') loadTeacherCourses();
            if (section === 'submissions') loadTeacherAssignments();
            if (section === 'forum') loadTeacherForum();
            if (section === 'liveMeet') loadTeacherLiveMeetings();
            if (section === 'previousPapers') loadTeacherPreviousPapers();
            if (section === 'semesterResults') loadTeacherSemesterResults();
            if (section === 'leaderboard') loadTeacherLeaderboard();
            if (section === 'notifications') loadTeacherNotifications();
        }

        async function loadTeacherCoursesForAttendance() {
            try {
                const response = await fetch(`/api/courses/${currentUser.department}`);
                const result = await response.json();
                
                const courseSelect = document.getElementById('attendanceCourse');
                courseSelect.innerHTML = '<option value="">Select a course</option>';
                
                if (result.success && result.courses.length > 0) {
                    const teacherCourses = result.courses.filter(course => course.teacherEmail === currentUser.email);
                    teacherCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.courseName;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teacher courses for attendance:', error);
            }
        }

        async function loadCourseStudents() {
            const courseId = document.getElementById('attendanceCourse').value;
            const date = document.getElementById('attendanceDate').value;
            
            if (!courseId) return;

            try {
                const response = await fetch(`/api/course-students/${courseId}`);
                const result = await response.json();
                
                let html = '';
                if (result.success && result.students.length > 0) {
                    // Reset attendance data
                    attendanceData = {};
                    
                    result.students.forEach(student => {
                        // Initialize attendance status for this student
                        attendanceData[student.email] = 'present';
                        
                        // Get student's attendance percentage
                        fetch(`/api/attendance/${student.email}`)
                            .then(response => response.json())
                            .then(attendanceResult => {
                                if (attendanceResult.success) {
                                    const courseAttendance = attendanceResult.attendance.filter(a => a.course === document.getElementById('attendanceCourse').options[document.getElementById('attendanceCourse').selectedIndex].text);
                                    const presentCount = courseAttendance.filter(a => a.status === 'present').length;
                                    const totalCount = courseAttendance.length;
                                    const percentage = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;
                                    
                                    // Update the percentage display
                                    const percentageElement = document.getElementById(`attendance-percentage-${student.email}`);
                                    if (percentageElement) {
                                        percentageElement.textContent = `${percentage}%`;
                                        // Color code based on percentage
                                        if (percentage >= 75) {
                                            percentageElement.className = 'percentage-value percentage-high';
                                        } else if (percentage >= 50) {
                                            percentageElement.className = 'percentage-value percentage-medium';
                                        } else {
                                            percentageElement.className = 'percentage-value percentage-low';
                                        }
                                    }
                                }
                            });
                        
                        html += `
                            <div class="attendance-student-card" id="student-${student.email}">
                                <div class="student-profile-section">
                                    <div class="student-avatar-large" style="${student.photo ? `background-image: url(${student.photo})` : ''}">
                                        ${!student.photo ? student.name.charAt(0) : ''}
                                    </div>
                                    <div class="student-details">
                                        <div class="student-name">${student.name}</div>
                                        <div class="student-email">${student.email}</div>
                                        <div class="student-roll">Roll No: ${student.rollNumber}</div>
                                    </div>
                                </div>
                                
                                <div class="attendance-status-section">
                                    <div class="attendance-percentage-display">
                                        <div class="percentage-value" id="attendance-percentage-${student.email}">0%</div>
                                        <div class="percentage-label">Course Attendance</div>
                                    </div>
                                    
                                    <div class="attendance-options">
                                        <div class="attendance-option present selected" onclick="setAttendanceStatus('${student.email}', 'present')">
                                            <i class="fas fa-check-circle"></i> Present
                                        </div>
                                        <div class="attendance-option absent" onclick="setAttendanceStatus('${student.email}', 'absent')">
                                            <i class="fas fa-times-circle"></i> Absent
                                        </div>
                                        <div class="attendance-option late" onclick="setAttendanceStatus('${student.email}', 'late')">
                                            <i class="fas fa-clock"></i> Late
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    // Update stats
                    document.getElementById('totalStudents').textContent = result.students.length;
                    document.getElementById('presentCount').textContent = result.students.length;
                    document.getElementById('absentCount').textContent = '0';
                    document.getElementById('lateCount').textContent = '0';
                } else {
                    html = '<p>No students enrolled in this course.</p>';
                }
                document.getElementById('courseStudentsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading course students:', error);
                document.getElementById('courseStudentsList').innerHTML = '<p>Error loading students</p>';
            }
        }

        // Set attendance status for a student
        function setAttendanceStatus(studentEmail, status) {
            attendanceData[studentEmail] = status;
            
            // Update UI
            const studentCard = document.getElementById(`student-${studentEmail}`);
            const options = studentCard.querySelectorAll('.attendance-option');
            
            options.forEach(option => {
                option.classList.remove('selected');
            });
            
            studentCard.querySelector(`.attendance-option.${status}`).classList.add('selected');
            
            // Update stats
            updateAttendanceStats();
        }

        // Update attendance statistics
        function updateAttendanceStats() {
            const total = Object.keys(attendanceData).length;
            let present = 0, absent = 0, late = 0;
            
            Object.values(attendanceData).forEach(status => {
                if (status === 'present') present++;
                if (status === 'absent') absent++;
                if (status === 'late') late++;
            });
            
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
            document.getElementById('lateCount').textContent = late;
        }

        // Mark all students as present
        function markAllPresent() {
            Object.keys(attendanceData).forEach(studentEmail => {
                setAttendanceStatus(studentEmail, 'present');
            });
        }

        // Mark all students as absent
        function markAllAbsent() {
            Object.keys(attendanceData).forEach(studentEmail => {
                setAttendanceStatus(studentEmail, 'absent');
            });
        }

        async function loadLeaveRequests() {
            try {
                const response = await fetch(`/api/leave-requests/${currentUser.department}`);
                const result = await response.json();
                
                if (result.success) {
                    const leaveRequestsList = document.getElementById('leaveRequestsList');
                    const leaveRequestsSection = document.getElementById('leaveRequestsSection');
                    
                    if (result.leaveRequests.length > 0) {
                        leaveRequestsSection.classList.remove('hidden');
                        leaveRequestsList.innerHTML = '';
                        
                        result.leaveRequests.forEach(request => {
                            const leaveItem = document.createElement('div');
                            leaveItem.className = 'leave-request feature-card';
                            leaveItem.innerHTML = `
                                <div class="leave-header">
                                    <h4>${request.userEmail}</h4>
                                    <span class="leave-status status-${request.status}">${request.status}</span>
                                </div>
                                <p><strong>Period:</strong> ${new Date(request.startDate).toLocaleDateString()} to ${new Date(request.endDate).toLocaleDateString()}</p>
                                <p><strong>Reason:</strong> ${request.reason}</p>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-success btn-sm" onclick="updateLeaveStatus('${request.id}', 'approved')">Approve</button>
                                    <button class="btn btn-danger btn-sm" onclick="updateLeaveStatus('${request.id}', 'rejected')">Reject</button>
                                </div>
                            `;
                            leaveRequestsList.appendChild(leaveItem);
                        });
                    } else {
                        leaveRequestsSection.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading leave requests:', error);
            }
        }

        async function updateLeaveStatus(leaveId, status) {
            try {
                const response = await fetch('/api/leave-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leaveId, status })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Leave request updated successfully');
                    loadLeaveRequests();
                }
            } catch (error) {
                alert('Leave status update failed: ' + error.message);
            }
        }

        async function loadStudentPerformance() {
            const studentEmail = document.getElementById('performanceStudent').value;
            if (!studentEmail) return;

            try {
                // Fetch student data
                const [attendanceRes, gradesRes] = await Promise.all([
                    fetch(`/api/attendance/${studentEmail}`),
                    fetch(`/api/grades/${studentEmail}`)
                ]);

                const attendanceResult = await attendanceRes.json();
                const gradesResult = await gradesRes.json();

                let html = '<div class="performance-chart">';
                
                if (attendanceResult.success) {
                    html += '<h3>Attendance</h3>';
                    // Group by course
                    const courseData = {};
                    attendanceResult.attendance.forEach(record => {
                        if (!courseData[record.course]) {
                            courseData[record.course] = { present: 0, total: 0 };
                        }
                        courseData[record.course].total++;
                        if (record.status === 'present') courseData[record.course].present++;
                    });

                    for (const [course, data] of Object.entries(courseData)) {
                        const percentage = (data.present / data.total) * 100;
                        let percentageClass = 'percentage-high';
                        if (percentage < 75) percentageClass = 'percentage-medium';
                        if (percentage < 50) percentageClass = 'percentage-low';
                        
                        html += `
                            <div style="margin-bottom: 10px;">
                                <strong>${course}:</strong> 
                                <span class="attendance-percentage ${percentageClass}">${percentage.toFixed(1)}%</span>
                                (${data.present}/${data.total})
                                <div class="graph-bar" style="width: ${percentage}%;"></div>
                            </div>
                        `;
                    }
                }

                if (gradesResult.success && gradesResult.grades.length > 0) {
                    html += '<h3 style="margin-top: 20px;">Grades</h3>';
                    gradesResult.grades.forEach(grade => {
                        html += `
                            <div class="feature-card" style="display: inline-block; margin: 5px;">
                                <h4>${grade.course}</h4>
                                <p>Grade: ${grade.grade}</p>
                                <p>Semester: ${grade.semester}</p>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                document.getElementById('performanceContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading student performance:', error);
                document.getElementById('performanceContent').innerHTML = '<p>Error loading performance data</p>';
            }
        }

        function handleCourseFileUpload(input) {
            if (input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    courseFiles.push(input.files[i]);
                }
                updateCourseFilesList();
            }
        }

        function updateCourseFilesList() {
            const filesList = document.getElementById('courseFilesList');
            filesList.innerHTML = '';
            
            courseFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">üìÑ</span>
                        <span>${file.name}</span>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeCourseFile(${index})">Remove</button>
                `;
                filesList.appendChild(fileItem);
            });
        }

        function removeCourseFile(index) {
            courseFiles.splice(index, 1);
            updateCourseFilesList();
        }

        function handleAssignmentFileUpload(input) {
            if (input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    assignmentFiles.push(input.files[i]);
                }
                updateAssignmentFilesList();
            }
        }

        function updateAssignmentFilesList() {
            const filesList = document.getElementById('assignmentFilesList');
            filesList.innerHTML = '';
            
            assignmentFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">üìÑ</span>
                        <span>${file.name}</span>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeAssignmentFile(${index})">Remove</button>
                `;
                filesList.appendChild(fileItem);
            });
        }

        function removeAssignmentFile(index) {
            assignmentFiles.splice(index, 1);
            updateAssignmentFilesList();
        }

        async function createCourse() {
            const formData = new FormData();
            formData.append('teacherEmail', currentUser.email);
            formData.append('courseName', document.getElementById('courseName').value);
            formData.append('description', document.getElementById('courseDescription').value);
            formData.append('duration', document.getElementById('courseDuration').value);
            formData.append('department', currentUser.department);
            
            // Add files
            courseFiles.forEach(file => {
                formData.append('files', file);
            });

            try {
                const response = await fetch('/api/courses', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    document.getElementById('courseName').value = '';
                    document.getElementById('courseDescription').value = '';
                    document.getElementById('courseDuration').value = '';
                    courseFiles = [];
                    updateCourseFilesList();
                    loadTeacherCourses();
                    loadTeacherStats();
                }
            } catch (error) {
                alert('Course creation failed: ' + error.message);
            }
        }

        async function loadTeacherCourses() {
            try {
                const response = await fetch(`/api/courses/${currentUser.department}`);
                const result = await response.json();
                
                let html = '<div class="grid">';
                if (result.success && result.courses.length > 0) {
                    const teacherCourses = result.courses.filter(course => course.teacherEmail === currentUser.email);
                    
                    if (teacherCourses.length > 0) {
                        teacherCourses.forEach(course => {
                            // Get enrolled students count
                            const enrolledStudents = enrollments.filter(enrollment => enrollment.courseId === course.id).length;
                            
                            html += `
                                <div class="course-card feature-card">
                                    <h3>${course.courseName}</h3>
                                    <p><strong>Duration:</strong> ${course.duration}</p>
                                    <p>${course.description}</p>
                                    <p><strong>Enrolled Students:</strong> ${enrolledStudents}</p>
                                    <button class="btn btn-primary" onclick="viewCourseStudents('${course.id}')">View Students</button>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p>You haven\'t created any courses yet.</p>';
                    }
                } else {
                    html += '<p>No courses found.</p>';
                }
                html += '</div>';
                document.getElementById('teacherCoursesContent').innerHTML = html;

                // Also populate course dropdowns
                const courseSelects = document.querySelectorAll('select[id*="Course"]');
                courseSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select course</option>';
                    if (result.success && result.courses.length > 0) {
                        result.courses.forEach(course => {
                            if (course.teacherEmail === currentUser.email) {
                                const option = document.createElement('option');
                                option.value = course.courseName;
                                option.textContent = course.courseName;
                                select.appendChild(option);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Error loading teacher courses:', error);
                document.getElementById('teacherCoursesContent').innerHTML = '<p>Error loading courses</p>';
            }
        }

        async function viewCourseStudents(courseId) {
            try {
                const response = await fetch(`/api/course-students/${courseId}`);
                const result = await response.json();
                
                if (result.success) {
                    let studentsHtml = '<h3>Enrolled Students:</h3><ul>';
                    result.students.forEach(student => {
                        studentsHtml += `<li>${student.name} (${student.rollNumber}) - ${student.email} - Enrolled: ${new Date(student.enrolledDate).toLocaleDateString()}</li>`;
                    });
                    studentsHtml += '</ul>';
                    alert(studentsHtml);
                }
            } catch (error) {
                alert('Error viewing course students: ' + error.message);
            }
        }

        async function loadTeacherAssignments() {
            try {
                const response = await fetch(`/api/assignments/${currentUser.department}`);
                const result = await response.json();
                
                const assignmentSelect = document.getElementById('submissionAssignment');
                assignmentSelect.innerHTML = '<option value="">Select assignment</option>';
                
                if (result.success && result.assignments.length > 0) {
                    const teacherAssignments = result.assignments.filter(assignment => assignment.teacherEmail === currentUser.email);
                    
                    teacherAssignments.forEach(assignment => {
                        const option = document.createElement('option');
                        option.value = assignment.id;
                        option.textContent = assignment.title;
                        assignmentSelect.appendChild(option);
                    });

                    // Also populate grade assignment dropdown
                    const gradeAssignmentSelect = document.getElementById('gradeAssignment');
                    gradeAssignmentSelect.innerHTML = '<option value="">Select assignment</option>';
                    teacherAssignments.forEach(assignment => {
                        const option = document.createElement('option');
                        option.value = assignment.id;
                        option.textContent = assignment.title;
                        gradeAssignmentSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teacher assignments:', error);
            }
        }

        async function loadAssignmentSubmissions() {
            const assignmentId = document.getElementById('submissionAssignment').value;
            if (!assignmentId) return;

            try {
                const response = await fetch(`/api/assignment-submissions/${assignmentId}`);
                const result = await response.json();
                
                let html = '';
                if (result.success && result.submissions.length > 0) {
                    html = '<h3>Submissions:</h3>';
                    result.submissions.forEach(submission => {
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <span class="file-icon">üìÑ</span>
                                    <span>${submission.studentEmail}</span>
                                    <span style="margin-left: 10px; color: #666;">Submitted: ${new Date(submission.submittedDate).toLocaleString()}</span>
                                </div>
                                <div>
                                    ${submission.file ? 
                                        `<button class="btn btn-primary btn-sm" onclick="downloadFile('${submission.file.url}', '${submission.file.name}')">Download</button>` :
                                        '<span>No file submitted</span>'
                                    }
                                    <button class="btn btn-success btn-sm" onclick="gradeSubmission('${submission.studentEmail}', '${assignmentId}')">Grade</button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>No submissions for this assignment yet.</p>';
                }
                document.getElementById('submissionsContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading assignment submissions:', error);
                document.getElementById('submissionsContent').innerHTML = '<p>Error loading submissions</p>';
            }
        }

        function gradeSubmission(studentEmail, assignmentId) {
            const grade = prompt(`Enter grade for ${studentEmail}:`);
            if (grade) {
                // Find the assignment to get course name
                const assignment = assignments.find(a => a.id === assignmentId);
                if (assignment) {
                    uploadGradeForStudent(studentEmail, assignment.course, assignmentId, grade);
                }
            }
        }

        async function uploadGradeForStudent(studentEmail, course, assignmentId, grade) {
            const gradeData = {
                teacherEmail: currentUser.email,
                studentEmail: studentEmail,
                course: course,
                grade: grade,
                semester: '2024-1',
                assignmentId: assignmentId
            };

            try {
                const response = await fetch('/api/grades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gradeData)
                });

                const result = await response.json();
                alert(result.message);
            } catch (error) {
                alert('Grade upload failed: ' + error.message);
            }
        }

        // Enhanced Attendance Recording
        async function recordAttendance() {
            const courseId = document.getElementById('attendanceCourse').value;
            const date = document.getElementById('attendanceDate').value;
            const courseName = document.getElementById('attendanceCourse').options[document.getElementById('attendanceCourse').selectedIndex].text;
            
            if (!courseId || !date) {
                alert('Please select a course and date');
                return;
            }

            if (Object.keys(attendanceData).length === 0) {
                alert('No students to record attendance for');
                return;
            }

            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const [studentEmail, status] of Object.entries(attendanceData)) {
                    const attendanceRecord = {
                        teacherEmail: currentUser.email,
                        studentEmail: studentEmail,
                        course: courseName,
                        date: date,
                        status: status
                    };

                    const response = await fetch('/api/attendance', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(attendanceRecord)
                    });

                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                        
                        // Send notification to student
                        sendNotification(
                            studentEmail,
                            'Attendance Recorded',
                            `Your attendance for ${courseName} on ${date} has been marked as ${status}.`,
                            'info'
                        );
                    } else {
                        errorCount++;
                    }
                }
                
                alert(`Attendance recorded for ${successCount} students. ${errorCount > 0 ? `${errorCount} errors occurred.` : ''}`);
                
                // Reset attendance data
                attendanceData = {};
                
            } catch (error) {
                alert('Attendance recording failed: ' + error.message);
            }
        }

        async function uploadGrade() {
            const gradeData = {
                teacherEmail: currentUser.email,
                studentEmail: document.getElementById('gradeStudent').value,
                course: document.getElementById('gradeCourse').value,
                grade: document.getElementById('studentGrade').value,
                semester: document.getElementById('gradeSemester').value,
                assignmentId: document.getElementById('gradeAssignment').value
            };

            try {
                const response = await fetch('/api/grades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gradeData)
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    document.getElementById('gradeStudent').value = '';
                    document.getElementById('gradeCourse').value = '';
                    document.getElementById('studentGrade').value = '';
                    document.getElementById('gradeSemester').value = '';
                    document.getElementById('gradeAssignment').value = '';
                }
            } catch (error) {
                alert('Grade upload failed: ' + error.message);
            }
        }

        async function uploadAssignment() {
            const formData = new FormData();
            formData.append('teacherEmail', currentUser.email);
            formData.append('title', document.getElementById('assignmentTitle').value);
            formData.append('description', document.getElementById('assignmentDescription').value);
            formData.append('dueDate', document.getElementById('assignmentDueDate').value);
            formData.append('course', document.getElementById('assignmentCourse').value);
            formData.append('department', currentUser.department);
            
            // Add files
            assignmentFiles.forEach(file => {
                formData.append('files', file);
            });

            try {
                const response = await fetch('/api/assignments', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    document.getElementById('assignmentTitle').value = '';
                    document.getElementById('assignmentDescription').value = '';
                    document.getElementById('assignmentDueDate').value = '';
                    document.getElementById('assignmentCourse').value = '';
                    assignmentFiles = [];
                    updateAssignmentFilesList();
                    loadTeacherAssignments();
                    loadTeacherStats();
                }
            } catch (error) {
                alert('Assignment upload failed: ' + error.message);
            }
        }

        async function uploadTimetable() {
            const fileInput = document.getElementById('timetableFile');
            if (!fileInput.files[0]) {
                alert('Please select a timetable image');
                return;
            }

            const formData = new FormData();
            formData.append('teacherEmail', currentUser.email);
            formData.append('department', document.getElementById('timetableDepartment').value);
            formData.append('description', document.getElementById('timetableDescription').value);
            formData.append('timetableImage', fileInput.files[0]);

            try {
                const response = await fetch('/api/timetable', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    document.getElementById('timetableDescription').value = '';
                    document.getElementById('timetableFile').value = '';
                    document.getElementById('timetablePreview').classList.add('hidden');
                }
            } catch (error) {
                alert('Timetable upload failed: ' + error.message);
            }
        }

        async function loadTeacherForum() {
            try {
                const response = await fetch(`/api/courses/${currentUser.department}`);
                const result = await response.json();
                
                const courseSelect = document.getElementById('teacherForumCourseSelect');
                courseSelect.innerHTML = '<option value="">Select a course</option>';
                
                if (result.success && result.courses.length > 0) {
                    const teacherCourses = result.courses.filter(course => course.teacherEmail === currentUser.email);
                    teacherCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.courseName;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teacher forum courses:', error);
            }
        }

        async function loadTeacherForumPosts() {
            const courseId = document.getElementById('teacherForumCourseSelect').value;
            if (!courseId) return;

            try {
                const response = await fetch(`/api/forum-posts/${courseId}`);
                const result = await response.json();
                
                let html = '';
                if (result.success && result.posts.length > 0) {
                    result.posts.forEach(post => {
                        html += `
                            <div class="forum-post feature-card">
                                <h4>${post.title}</h4>
                                <p><strong>By:</strong> ${post.userEmail}</p>
                                <p>${post.content}</p>
                                <p><small>Posted: ${new Date(post.createdDate).toLocaleString()}</small></p>
                                
                                <div class="forum-replies">
                                    <h5>Replies (${post.replies.length}):</h5>
                                    ${post.replies.map(reply => `
                                        <div class="forum-reply">
                                            <p><strong>${reply.userEmail}:</strong> ${reply.content}</p>
                                            <p><small>${new Date(reply.createdDate).toLocaleString()}</small></p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>No discussions in this course yet.</p>';
                }
                
                document.getElementById('teacherForumContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading teacher forum posts:', error);
                document.getElementById('teacherForumContent').innerHTML = '<p>Error loading forum posts</p>';
            }
        }

        // Live Meeting Functions for Teachers
        function loadTeacherLiveMeetings() {
            // Load teacher courses for meeting selection
            loadTeacherCoursesForMeeting();
        }

        async function loadTeacherCoursesForMeeting() {
            try {
                const response = await fetch(`/api/courses/${currentUser.department}`);
                const result = await response.json();
                
                const courseSelect = document.getElementById('meetingCourse');
                courseSelect.innerHTML = '<option value="">Select a course</option>';
                
                if (result.success && result.courses.length > 0) {
                    const teacherCourses = result.courses.filter(course => course.teacherEmail === currentUser.email);
                    teacherCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.courseName;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teacher courses for meeting:', error);
            }
        }

        function loadCourseStudentsForMeeting() {
            const courseId = document.getElementById('meetingCourse').value;
            if (!courseId) return;

            // In a real application, this would fetch enrolled students
            // For now, we'll use the online students list
            updateOnlineStudentsList();
        }

        function startLiveMeeting() {
            const courseId = document.getElementById('meetingCourse').value;
            if (!courseId) {
                alert('Please select a course');
                return;
            }

            // Generate a unique meeting URL (in a real app, this would use a service like Zoom or Google Meet API)
            const meetingId = 'meet-' + Math.random().toString(36).substring(2, 10);
            const meetingUrl = `https://meet.jit.si/${meetingId}`;
            
            activeMeeting = {
                id: meetingId,
                courseId: courseId,
                url: meetingUrl,
                teacher: currentUser.email,
                startTime: new Date()
            };

            // Show meeting room
            document.getElementById('meetingRoom').classList.remove('hidden');
            document.getElementById('meetIframe').src = meetingUrl;
            
            // Load online students
            updateOnlineStudentsList();
        }

        function updateOnlineStudentsList() {
            let html = '';
            if (onlineStudents.length > 0) {
                onlineStudents.forEach(student => {
                    html += `
                        <div class="online-student feature-card">
                            <h4>${student.name}</h4>
                            <p>${student.email}</p>
                            <div class="student-status">
                                <div class="status-indicator status-online"></div>
                                <span>Online</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<p>No students online at the moment.</p>';
            }
            document.getElementById('onlineStudentsList').innerHTML = html;
        }

        function updateOnlineStudents(data) {
            // Check if student is already in the list
            const existingIndex = onlineStudents.findIndex(s => s.email === data.email);
            if (existingIndex === -1) {
                onlineStudents.push({
                    email: data.email,
                    name: data.name
                });
                updateOnlineStudentsList();
            }
        }

        function removeOnlineStudent(email) {
            onlineStudents = onlineStudents.filter(s => s.email !== email);
            updateOnlineStudentsList();
        }

        function sendMeetingInvites() {
            if (!activeMeeting) {
                alert('Please start a meeting first');
                return;
            }

            const courseId = document.getElementById('meetingCourse').value;
            const courseName = document.getElementById('meetingCourse').options[document.getElementById('meetingCourse').selectedIndex].text;
            
            // Send invites to all enrolled students
            fetch(`/api/course-students/${courseId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        result.students.forEach(student => {
                            // Send notification to student
                            socket.emit('meeting-invitation', {
                                studentEmail: student.email,
                                course: courseName,
                                teacher: currentUser.name,
                                meetingUrl: activeMeeting.url
                            });
                        });
                        
                        alert(`Meeting invitations sent to ${result.students.length} students`);
                        
                        // Show invited students list
                        document.getElementById('meetingInvites').classList.remove('hidden');
                        let invitedHtml = '';
                        result.students.forEach(student => {
                            invitedHtml += `<div class="online-student feature-card">
                                <h4>${student.name}</h4>
                                <p>${student.email}</p>
                                <div class="student-status">
                                    <div class="status-indicator status-offline"></div>
                                    <span>Invited</span>
                                </div>
                            </div>`;
                        });
                        document.getElementById('invitedStudentsList').innerHTML = invitedHtml;
                    }
                });
        }

        // Previous Papers Management for Teachers
        function loadTeacherPreviousPapers() {
            // This would load existing papers in a real application
        }

        function handlePaperUpload(input) {
            // Handle paper file upload
        }

        async function uploadPaper() {
            const title = document.getElementById('paperTitle').value;
            const subject = document.getElementById('paperSubjectTeacher').value;
            const semester = document.getElementById('paperSemester').value;
            const year = document.getElementById('paperYear').value;
            const fileInput = document.getElementById('paperFile');
            
            if (!title || !subject || !semester || !year || !fileInput.files[0]) {
                alert('Please fill in all fields and select a file');
                return;
            }

            const formData = new FormData();
            formData.append('teacherEmail', currentUser.email);
            formData.append('title', title);
            formData.append('subject', subject);
            formData.append('semester', semester);
            formData.append('year', year);
            formData.append('paperFile', fileInput.files[0]);

            try {
                const response = await fetch('/api/previous-papers', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    document.getElementById('paperTitle').value = '';
                    document.getElementById('paperSemester').value = '';
                    document.getElementById('paperYear').value = '';
                    document.getElementById('paperFile').value = '';
                }
            } catch (error) {
                alert('Paper upload failed: ' + error.message);
            }
        }

        // Semester Results Management
        function loadTeacherSemesterResults() {
            // Load teacher courses for results
            loadTeacherCoursesForResults();
        }

        async function loadTeacherCoursesForResults() {
            try {
                const response = await fetch(`/api/courses/${currentUser.department}`);
                const result = await response.json();
                
                const courseSelect = document.getElementById('resultsCourse');
                courseSelect.innerHTML = '<option value="">Select a course</option>';
                
                if (result.success && result.courses.length > 0) {
                    const teacherCourses = result.courses.filter(course => course.teacherEmail === currentUser.email);
                    teacherCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.courseName;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading teacher courses for results:', error);
            }
        }

        async function loadCourseResults() {
            const courseId = document.getElementById('resultsCourse').value;
            if (!courseId) return;

            // In a real application, this would fetch student grades for the course
        }

        async function generateResultsTable() {
            const courseId = document.getElementById('resultsCourse').value;
            const semester = document.getElementById('resultsSemester').value;
            
            if (!courseId || !semester) {
                alert('Please select a course and enter semester');
                return;
            }

            try {
                // Fetch enrolled students
                const studentsResponse = await fetch(`/api/course-students/${courseId}`);
                const studentsResult = await studentsResponse.json();
                
                if (studentsResult.success) {
                    const courseName = document.getElementById('resultsCourse').options[document.getElementById('resultsCourse').selectedIndex].text;
                    
                    document.getElementById('resultsCourseName').textContent = courseName;
                    document.getElementById('resultsSemesterName').textContent = semester;
                    
                    let tableHtml = '';
                    studentsResult.students.forEach(student => {
                        // In a real application, this would fetch actual grades
                        const grade = 'A'; // Placeholder
                        const status = 'Pass'; // Placeholder
                        
                        tableHtml += `
                            <tr>
                                <td style="padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef;">${student.name}</td>
                                <td style="padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef;">${student.rollNumber}</td>
                                <td style="padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef;">${grade}</td>
                                <td style="padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef;">${status}</td>
                            </tr>
                        `;
                    });
                    
                    document.getElementById('resultsTableBody').innerHTML = tableHtml;
                    document.getElementById('resultsTableContainer').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error generating results table:', error);
                alert('Error generating results table');
            }
        }

        async function publishResults() {
            const courseId = document.getElementById('resultsCourse').value;
            const semester = document.getElementById('resultsSemester').value;
            
            if (!courseId || !semester) {
                alert('Please select a course and enter semester');
                return;
            }

            try {
                // Fetch enrolled students to notify them
                const studentsResponse = await fetch(`/api/course-students/${courseId}`);
                const studentsResult = await studentsResponse.json();
                
                if (studentsResult.success) {
                    const courseName = document.getElementById('resultsCourse').options[document.getElementById('resultsCourse').selectedIndex].text;
                    
                    // Notify each student
                    studentsResult.students.forEach(student => {
                        sendNotification(
                            student.email,
                            'Semester Results Published',
                            `The results for ${courseName} - ${semester} have been published. Check your results section.`,
                            'info'
                        );
                    });
                    
                    alert('Results published successfully! Students have been notified.');
                }
            } catch (error) {
                console.error('Error publishing results:', error);
                alert('Error publishing results');
            }
        }

        // Leaderboard Functions for Teachers
        async function loadTeacherLeaderboard() {
            try {
                const [currentResponse, historyResponse, statsResponse] = await Promise.all([
                    fetch('/api/leaderboard/current'),
                    fetch('/api/leaderboard/history'),
                    fetch(`/api/students/${currentUser.department}`)
                ]);
                
                const currentResult = await currentResponse.json();
                const historyResult = await historyResponse.json();
                const statsResult = await statsResponse.json();
                
                // Update stats
                document.getElementById('activeStudents').textContent = statsResult.success ? statsResult.students.length : 0;
                document.getElementById('leaderboardCount').textContent = historyResult.success ? historyResult.leaderboards.length : 0;
                
                let totalCredits = 0;
                if (currentResult.success && currentResult.leaderboard) {
                    currentResult.leaderboard.topStudents.forEach(student => {
                        totalCredits += student.credits;
                    });
                }
                document.getElementById('totalCreditsAwarded').textContent = totalCredits;
                
                // Display current leaderboard
                let currentHtml = '';
                if (currentResult.success && currentResult.leaderboard) {
                    const leaderboard = currentResult.leaderboard;
                    currentHtml = `
                        <h3 style="color: white; margin-bottom: 20px;">${leaderboard.month} ${leaderboard.year} Leaderboard</h3>
                        <div class="leaderboard-winners">
                            ${leaderboard.topStudents.map((student, index) => `
                                <div class="winner-card ${index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze'}">
                                    <div class="winner-position">#${student.position}</div>
                                    <div class="winner-medal">
                                        ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                                    </div>
                                    <div class="winner-name">${student.name}</div>
                                    <div class="winner-credits">+${student.credits} Credits</div>
                                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">${student.email}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    currentHtml = '<p style="color: white; text-align: center;">No leaderboard for current month.</p>';
                }
                document.getElementById('currentLeaderboard').innerHTML = currentHtml;
                
                // Display history
                let historyHtml = '';
                if (historyResult.success && historyResult.leaderboards.length > 0) {
                    historyHtml = '<h3 style="color: white; margin: 30px 0 15px 0;">Previous Leaderboards</h3>';
                    historyResult.leaderboards.forEach(leaderboard => {
                        historyHtml += `
                            <div class="feature-card" style="margin-bottom: 15px;">
                                <h4>${leaderboard.month} ${leaderboard.year}</h4>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                                    ${leaderboard.topStudents.map(student => `
                                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                            <div style="font-weight: 600; color: white;">#${student.position} ${student.name}</div>
                                            <div style="color: #2ecc71; font-size: 0.9rem;">${student.credits} credits</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }
                document.getElementById('leaderboardHistory').innerHTML = historyHtml;
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        async function showCreateLeaderboardForm() {
            try {
                const response = await fetch(`/api/students/${currentUser.department}`);
                const result = await response.json();
                
                if (result.success) {
                    let html = '';
                    for (let i = 1; i <= 3; i++) {
                        html += `
                            <div class="form-group">
                                <label>#${i} Position</label>
                                <select id="topStudent${i}">
                                    <option value="">Select student</option>
                                    ${result.students.map(student => `
                                        <option value="${student.email}">${student.name} (${student.rollNumber})</option>
                                    `).join('')}
                                </select>
                            </div>
                        `;
                    }
                    document.getElementById('topStudentsSelection').innerHTML = html;
                    document.getElementById('createLeaderboardForm').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading students for leaderboard:', error);
            }
        }

        async function publishLeaderboard() {
            const month = document.getElementById('leaderboardMonth').value;
            const year = document.getElementById('leaderboardYear').value;
            
            const topStudents = [];
            for (let i = 1; i <= 3; i++) {
                const studentEmail = document.getElementById(`topStudent${i}`).value;
                if (!studentEmail) {
                    alert(`Please select student for position #${i}`);
                    return;
                }
                
                // Get student name
                const studentResponse = await fetch(`/api/profile/${studentEmail}`);
                const studentResult = await studentResponse.json();
                
                if (studentResult.success) {
                    topStudents.push({
                        email: studentEmail,
                        name: studentResult.user.name
                    });
                }
            }
            
            const leaderboardData = {
                teacherEmail: currentUser.email,
                month,
                year: parseInt(year),
                topStudents
            };
            
            try {
                const response = await fetch('/api/leaderboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(leaderboardData)
                });
                
                const result = await response.json();
                alert(result.message);
                
                if (result.success) {
                    document.getElementById('createLeaderboardForm').classList.add('hidden');
                    loadTeacherLeaderboard();
                }
            } catch (error) {
                alert('Leaderboard publication failed: ' + error.message);
            }
        }

        async function loadTeacherNotifications() {
            try {
                const response = await fetch(`/api/notifications/${currentUser.email}`);
                const result = await response.json();
                
                let html = '';
                if (result.success && result.notifications.length > 0) {
                    result.notifications.forEach(notification => {
                        html += `
                            <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="markTeacherNotificationAsRead('${notification.id}')">
                                <h4>${notification.title}</h4>
                                <p>${notification.message}</p>
                                <p><small>${new Date(notification.timestamp).toLocaleString()}</small></p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>No notifications.</p>';
                }
                document.getElementById('teacherNotificationsContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading teacher notifications:', error);
                document.getElementById('teacherNotificationsContent').innerHTML = '<p>Error loading notifications</p>';
            }
        }

        async function markTeacherNotificationAsRead(notificationId) {
            try {
                const response = await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notificationId })
                });

                const result = await response.json();
                if (result.success) {
                    updateNotificationBadge();
                    loadTeacherNotifications();
                }
            } catch (error) {
                console.error('Error marking teacher notification as read:', error);
            }
        }

        // Parent functions
        function loadParentProfile() {
            document.getElementById('parentName').textContent = currentUser.name;
            const profilePic = document.getElementById('parentProfilePic');
            const profilePicLarge = document.getElementById('parentProfilePicLarge');
            
            if (currentUser.photo) {
                profilePic.style.backgroundImage = `url(${currentUser.photo})`;
                profilePic.textContent = '';
                profilePicLarge.style.backgroundImage = `url(${currentUser.photo})`;
                profilePicLarge.textContent = '';
            } else {
                profilePic.textContent = currentUser.name.charAt(0);
                profilePicLarge.textContent = currentUser.name.charAt(0);
            }
            
            document.getElementById('parentProfileName').textContent = currentUser.name;
            document.getElementById('parentProfileEmail').textContent = currentUser.email;
        }

        function showParentSection(section) {
            document.querySelectorAll('.parent-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById('parent' + section.charAt(0).toUpperCase() + section.slice(1)).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            event.target.classList.add('active');

            if (section === 'studentInfo') loadStudentInfo();
            if (section === 'attendance') loadParentAttendance();
            if (section === 'results') loadParentResults();
            if (section === 'timetable') loadParentTimetable();
            if (section === 'performance') loadParentPerformance();
            if (section === 'leaderboard') loadParentLeaderboard();
            if (section === 'notifications') loadParentNotifications();
        }

        async function loadStudentInfo() {
            try {
                const studentEmail = currentUser.studentEmail;
                const response = await fetch(`/api/profile/${studentEmail}`);
                const result = await response.json();
                
                let html = '';
                if (result.success) {
                    const student = result.user;
                    html = `
                        <div class="profile-header">
                            <h3>Student Information</h3>
                            <div class="profile-pic">${student.name.charAt(0)}</div>
                            <h3>${student.name}</h3>
                            <p>Email: ${student.email}</p>
                            <p>Roll Number: ${student.rollNumber}</p>
                            <p>Department: ${student.department.replace('_', ' ').toUpperCase()}</p>
                            <p>Father's Name: ${student.fatherName}</p>
                        </div>
                    `;
                } else {
                    html = '<p>Unable to load student information.</p>';
                }
                document.getElementById('studentInfoContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading student info:', error);
                document.getElementById('studentInfoContent').innerHTML = '<p>Error loading student information</p>';
            }
        }

        async function loadParentAttendance() {
            try {
                const studentEmail = currentUser.studentEmail;
                const response = await fetch(`/api/attendance/${studentEmail}`);
                const result = await response.json();
                
                let html = '<h3>Student Attendance</h3>';
                if (result.success && result.attendance.length > 0) {
                    // Group by course
                    const courseData = {};
                    result.attendance.forEach(record => {
                        if (!courseData[record.course]) {
                            courseData[record.course] = { present: 0, total: 0 };
                        }
                        courseData[record.course].total++;
                        if (record.status === 'present') courseData[record.course].present++;
                    });

                    html += '<div class="attendance-graph">';
                    for (const [course, data] of Object.entries(courseData)) {
                        const percentage = (data.present / data.total) * 100;
                        let percentageClass = 'percentage-high';
                        if (percentage < 75) percentageClass = 'percentage-medium';
                        if (percentage < 50) percentageClass = 'percentage-low';
                        
                        html += `
                            <div style="margin-bottom: 15px;">
                                <h4>${course}</h4>
                                <p>Attendance: <span class="attendance-percentage ${percentageClass}">${percentage.toFixed(1)}%</span> (${data.present}/${data.total})</p>
                                <div class="graph-bar" style="width: ${percentage}%;"></div>
                            </div>
                        `;
                    }
                    html += '</div>';
                } else {
                    html += '<p>No attendance records available.</p>';
                }
                document.getElementById('parentAttendanceContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading parent attendance:', error);
                document.getElementById('parentAttendanceContent').innerHTML = '<p>Error loading attendance</p>';
            }
        }

        async function loadParentResults() {
            try {
                const studentEmail = currentUser.studentEmail;
                const [gradesResponse, overallResponse] = await Promise.all([
                    fetch(`/api/grades/${studentEmail}`),
                    fetch(`/api/overall-grades/${studentEmail}`)
                ]);
                
                const gradesResult = await gradesResponse.json();
                const overallResult = await overallResponse.json();
                
                let html = '<h3>Student Results</h3>';
                if (gradesResult.success && gradesResult.grades.length > 0) {
                    html += '<div class="grid">';
                    gradesResult.grades.forEach(grade => {
                        html += `
                            <div class="feature-card">
                                <h3>${grade.course}</h3>
                                <p>Grade: ${grade.grade}</p>
                                <p>Semester: ${grade.semester}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<p>No grades available yet.</p>';
                }

                // Overall grades
                if (overallResult.success) {
                    html += '<h3 style="margin-top: 30px;">Overall Performance</h3>';
                    html += '<div class="grid">';
                    Object.keys(overallResult.overallGrades).forEach(course => {
                        const data = overallResult.overallGrades[course];
                        html += `
                            <div class="feature-card">
                                <h3>${course}</h3>
                                <p>Overall Grade: ${data.average}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                document.getElementById('parentResultsContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading parent results:', error);
                document.getElementById('parentResultsContent').innerHTML = '<p>Error loading results</p>';
            }
        }

        async function loadParentTimetable() {
            try {
                // Get student's department
                const studentEmail = currentUser.studentEmail;
                const response = await fetch(`/api/profile/${studentEmail}`);
                const result = await response.json();
                
                let html = '';
                if (result.success) {
                    const student = result.user;
                    const timetableResponse = await fetch(`/api/timetable/${student.department}`);
                    const timetableResult = await timetableResponse.json();
                    
                    if (timetableResult.success && timetableResult.timetable) {
                        html = `
                            <h3>${timetableResult.timetable.description}</h3>
                            <p><strong>Uploaded by:</strong> ${timetableResult.timetable.teacherEmail}</p>
                            <p><strong>Date:</strong> ${new Date(timetableResult.timetable.uploadedDate).toLocaleDateString()}</p>
                            ${timetableResult.timetable.image ? `<img src="${timetableResult.timetable.image}" alt="Timetable" class="timetable-image">` : '<p>No timetable image available.</p>'}
                        `;
                    } else {
                        html = '<p>No timetable available for your child\'s department.</p>';
                    }
                } else {
                    html = '<p>Unable to load timetable information.</p>';
                }
                document.getElementById('parentTimetableContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading parent timetable:', error);
                document.getElementById('parentTimetableContent').innerHTML = '<p>Error loading timetable</p>';
            }
        }

        async function loadParentPerformance() {
            try {
                const studentEmail = currentUser.studentEmail;
                const response = await fetch(`/api/performance/${studentEmail}`);
                const result = await response.json();
                
                if (result.success) {
                    let html = '';
                    
                    // Attendance Summary
                    if (result.attendance) {
                        html += '<div class="performance-card"><h3>Attendance Summary</h3>';
                        Object.keys(result.attendance).forEach(course => {
                            const data = result.attendance[course];
                            html += `
                                <div style="margin-bottom: 15px;">
                                    <h4>${course}</h4>
                                    <p>Attendance: ${data.percentage.toFixed(1)}% (${data.present}/${data.total})</p>
                                    <div class="graph-bar" style="width: ${data.percentage}%;"></div>
                            </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    // Grade Distribution
                    if (result.grades && result.grades.length > 0) {
                        const gradeCount = {};
                        result.grades.forEach(grade => {
                            gradeCount[grade.grade] = (gradeCount[grade.grade] || 0) + 1;
                        });
                        
                        html += '<div class="performance-card"><h3>Grade Distribution</h3>';
                        Object.keys(gradeCount).forEach(grade => {
                            const count = gradeCount[grade];
                            html += `<p>${grade}: ${count} assignments</p>`;
                        });
                        html += '</div>';
                    }
                    
                    document.getElementById('parentPerformanceContent').innerHTML = html;
                } else {
                    document.getElementById('parentPerformanceContent').innerHTML = '<p>No performance data available.</p>';
                }
            } catch (error) {
                console.error('Error loading parent performance:', error);
                document.getElementById('parentPerformanceContent').innerHTML = '<p>Error loading performance data</p>';
            }
        }

        async function loadParentLeaderboard() {
            try {
                const studentEmail = currentUser.studentEmail;
                const [leaderboardResponse, creditsResponse] = await Promise.all([
                    fetch('/api/leaderboard/current'),
                    fetch(`/api/student/credits/${studentEmail}`)
                ]);
                
                const leaderboardResult = await leaderboardResponse.json();
                const creditsResult = await creditsResponse.json();
                
                let html = '<h3>Student Leaderboard</h3>';
                if (leaderboardResult.success && leaderboardResult.leaderboard) {
                    const leaderboard = leaderboardResult.leaderboard;
                    const isOnLeaderboard = leaderboard.topStudents.some(student => student.email === studentEmail);
                    
                    html += `
                        <div class="leaderboard-container">
                            <div class="leaderboard-header">
                                <h3 class="leaderboard-title">${leaderboard.month} ${leaderboard.year} Leaderboard</h3>
                                <div class="credits-display">
                                    <span class="credits-badge">${creditsResult.success ? creditsResult.credits : 0} Credits</span>
                                </div>
                            </div>
                            ${isOnLeaderboard ? `
                                <div class="feature-card" style="background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1)); border-color: #ffd700; text-align: center; margin-bottom: 20px;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;">üéâ</div>
                                    <h3 style="color: #ffd700;">Congratulations!</h3>
                                    <p style="color: white;">Your child is on this month's leaderboard!</p>
                                </div>
                            ` : ''}
                            <div class="leaderboard-winners">
                                ${leaderboard.topStudents.map((student, index) => `
                                    <div class="winner-card ${index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze'} ${student.email === studentEmail ? 'current-user' : ''}">
                                        <div class="winner-position">#${student.position}</div>
                                        <div class="winner-medal">
                                            ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                                        </div>
                                        <div class="winner-name">${student.name} ${student.email === studentEmail ? ' (Your Child)' : ''}</div>
                                        <div class="winner-credits">+${student.credits} Credits</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    html += '<p style="color: white; text-align: center;">No leaderboard available for current month.</p>';
                }
                document.getElementById('parentLeaderboardContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading parent leaderboard:', error);
                document.getElementById('parentLeaderboardContent').innerHTML = '<p>Error loading leaderboard</p>';
            }
        }

        async function loadParentTeachers() {
            try {
                // Get student's department
                const studentEmail = currentUser.studentEmail;
                const response = await fetch(`/api/profile/${studentEmail}`);
                const result = await response.json();
                
                if (result.success) {
                    const student = result.user;
                    const teachersResponse = await fetch(`/api/teachers/${student.department}`);
                    const teachersResult = await teachersResponse.json();
                    
                    if (teachersResult.success) {
                        const teacherList = document.getElementById('teacherList');
                        teacherList.innerHTML = '';
                        
                        teachersResult.teachers.forEach(teacher => {
                            const teacherItem = document.createElement('div');
                            teacherItem.className = 'chat-teacher-item feature-card';
                            teacherItem.innerHTML = `
                                <i class="fas fa-chalkboard-teacher"></i>
                                <div>
                                    <h4>${teacher.name}</h4>
                                    <p>${teacher.subject} - ${teacher.email}</p>
                                </div>
                            `;
                            teacherItem.onclick = () => selectTeacher(teacher);
                            teacherList.appendChild(teacherItem);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading parent teachers:', error);
            }
        }

        function selectTeacher(teacher) {
            selectedTeacher = teacher;
            document.getElementById('teacherChatInput').classList.remove('hidden');
            document.getElementById('teacherList').classList.add('hidden');
            
            // Join chat room
            socket.emit('join-chat', {
                parentEmail: currentUser.email,
                teacherEmail: teacher.email
            });
            
            // Load chat history
            loadChatHistory(teacher.email);
        }

        async function loadChatHistory(teacherEmail) {
            try {
                const response = await fetch(`/api/chat-messages/${currentUser.email}/${teacherEmail}`);
                const result = await response.json();
                
                const chatMessages = document.getElementById('teacherChatMessages');
                chatMessages.innerHTML = '';
                
                if (result.success && result.messages.length > 0) {
                    result.messages.forEach(message => {
                        displayChatMessage(message);
                    });
                } else {
                    chatMessages.innerHTML = '<div class="chat-message teacher-message">Start a conversation with the teacher.</div>';
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        function displayChatMessage(message) {
            const chatMessages = document.getElementById('teacherChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.sender === 'parent' ? 'parent-message' : 'teacher-message'}`;
            messageDiv.textContent = message.message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendTeacherMessage() {
            const input = document.getElementById('teacherChatInputField');
            const message = input.value.trim();
            
            if (message && selectedTeacher) {
                socket.emit('send-chat-message', {
                    parentEmail: currentUser.email,
                    teacherEmail: selectedTeacher.email,
                    message: message,
                    sender: 'parent'
                });
                
                input.value = '';
            }
        }

        async function loadParentNotifications() {
            try {
                const response = await fetch(`/api/notifications/${currentUser.email}`);
                const result = await response.json();
                
                let html = '';
                if (result.success && result.notifications.length > 0) {
                    result.notifications.forEach(notification => {
                        html += `
                            <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="markParentNotificationAsRead('${notification.id}')">
                                <h4>${notification.title}</h4>
                                <p>${notification.message}</p>
                                <p><small>${new Date(notification.timestamp).toLocaleString()}</small></p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>No notifications.</p>';
                }
                document.getElementById('parentNotificationsContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading parent notifications:', error);
                document.getElementById('parentNotificationsContent').innerHTML = '<p>Error loading notifications</p>';
            }
        }

        async function markParentNotificationAsRead(notificationId) {
            try {
                const response = await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notificationId })
                });

                const result = await response.json();
                if (result.success) {
                    updateNotificationBadge();
                    loadParentNotifications();
                }
            } catch (error) {
                console.error('Error marking parent notification as read:', error);
            }
        }

        async function updateNotificationBadge() {
            try {
                const response = await fetch(`/api/notifications/${currentUser.email}`);
                const result = await response.json();
                
                if (result.success) {
                    const unreadCount = result.notifications.filter(n => !n.read).length;
                    let badge;
                    if (currentUserType === 'student') {
                        badge = document.getElementById('studentNotificationBadge');
                    } else if (currentUserType === 'teacher') {
                        badge = document.getElementById('teacherNotificationBadge');
                    } else if (currentUserType === 'parent') {
                        badge = document.getElementById('parentNotificationBadge');
                    }
                    
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        function downloadFile(url, filename) {
            // In a real application, this would download the file
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Chatbot functions
        function toggleChatbot() {
            const chatbot = document.getElementById('chatbot');
            chatbot.classList.toggle('hidden');
        }

        function toggleTeacherChat() {
            const teacherChat = document.getElementById('teacherChat');
            teacherChat.classList.toggle('hidden');
        }

        // Enhanced AI Chatbot with Portal Information
        async function sendChatMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (message) {
                // Add user message
                addChatMessage(message, 'user');
                input.value = '';

                try {
                    // Get AI response
                    const response = await fetch('/api/chatbot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: message,
                            userType: currentUserType,
                            context: getChatbotContext()
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        addChatMessage(result.response, 'bot');
                    } else {
                        addChatMessage(getDefaultResponse(message), 'bot');
                    }
                } catch (error) {
                    addChatMessage(getDefaultResponse(message), 'bot');
                }
            }
        }

        function getChatbotContext() {
            // Provide context based on user type and current section
            let context = {
                userType: currentUserType,
                features: []
            };
            
            if (currentUserType === 'student') {
                context.features = [
                    'course enrollment',
                    'attendance tracking',
                    'assignment submission',
                    'grade viewing',
                    'live meetings',
                    'previous papers',
                    'discussion forum',
                    'monthly leaderboard'
                ];
            } else if (currentUserType === 'teacher') {
                context.features = [
                    'course creation',
                    'attendance management',
                    'assignment creation',
                    'grade management',
                    'live meetings',
                    'previous papers upload',
                    'semester results',
                    'monthly leaderboard'
                ];
            } else if (currentUserType === 'parent') {
                context.features = [
                    'student progress tracking',
                    'attendance monitoring',
                    'grade viewing',
                    'teacher communication',
                    'leaderboard viewing'
                ];
            }
            
            return context;
        }

        function getDefaultResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Portal information responses
            if (lowerMessage.includes('portal') || lowerMessage.includes('system') || lowerMessage.includes('eduportal')) {
                return 'EduPortal is a comprehensive student and teacher management system that helps manage academic activities, track progress, and facilitate communication between students, teachers, and parents.';
            }
            
            if (lowerMessage.includes('feature') || lowerMessage.includes('what can') || lowerMessage.includes('help')) {
                let features = '';
                if (currentUserType === 'student') {
                    features = 'As a student, you can enroll in courses, view attendance, submit assignments, check grades, join live meetings, access previous question papers, participate in discussion forums, and check monthly leaderboard rankings.';
                } else if (currentUserType === 'teacher') {
                    features = 'As a teacher, you can create courses, manage attendance, upload assignments and grades, conduct live meetings, upload previous question papers, publish semester results, and create monthly leaderboards.';
                } else if (currentUserType === 'parent') {
                    features = 'As a parent, you can monitor your child\'s attendance, view their grades and performance, check their timetable, communicate with teachers, and see leaderboard rankings.';
                } else {
                    features = 'The portal offers course management, attendance tracking, assignment submission, grade management, live meetings, previous papers, communication features, and monthly leaderboards for students, teachers, and parents.';
                }
                return features;
            }
            
            if (lowerMessage.includes('course') || lowerMessage.includes('enroll')) {
                return 'You can browse and enroll in available courses through the "Available Courses" section. Once enrolled, you can access course materials, video resources, and participate in course discussions.';
            }
            
            if (lowerMessage.includes('attendance')) {
                return 'Attendance records show your class participation percentage for each course. Teachers mark attendance, and you can view your attendance statistics in the Attendance section.';
            }
            
            if (lowerMessage.includes('assignment')) {
                return 'Assignments are posted by teachers with due dates. You can submit your work through the Assignments section. Make sure to submit before the deadline to avoid penalties.';
            }
            
            if (lowerMessage.includes('grade') || lowerMessage.includes('result')) {
                return 'Grades are assigned by teachers for assignments and exams. You can view your grades and overall performance in the Results section. Semester results are published by teachers.';
            }
            
            if (lowerMessage.includes('meeting') || lowerMessage.includes('live')) {
                return 'Teachers can conduct live meetings for enrolled students. You will receive meeting invitations that you can join through the Live Meetings section.';
            }
            
            if (lowerMessage.includes('paper') || lowerMessage.includes('question') || lowerMessage.includes('previous')) {
                return 'Previous question papers are uploaded by teachers and can be accessed in the Previous Papers section. These are helpful for exam preparation.';
            }
            
            if (lowerMessage.includes('forum') || lowerMessage.includes('discussion')) {
                return 'The discussion forum allows you to ask questions and participate in course-related discussions with teachers and other students in your enrolled courses.';
            }
            
            if (lowerMessage.includes('timetable') || lowerMessage.includes('schedule')) {
                return 'Your class timetable is available in the Timetable section. It shows your daily or weekly class schedule organized by your department.';
            }
            
            if (lowerMessage.includes('notification')) {
                return 'You will receive notifications for important updates like new assignments, grade postings, meeting invitations, and system announcements.';
            }
            
            if (lowerMessage.includes('complaint') || lowerMessage.includes('issue')) {
                return 'If you have any concerns or issues, you can raise a complaint through the Raise Complaint section. Your complaints will be reviewed by the administration.';
            }
            
            if (lowerMessage.includes('leave') || lowerMessage.includes('absence')) {
                return 'You can request leave through the Request Leave section. Approved leaves will not affect your attendance record.';
            }
            
            if (lowerMessage.includes('leaderboard') || lowerMessage.includes('ranking') || lowerMessage.includes('credit')) {
                return 'The monthly leaderboard showcases top-performing students. Students earn performance credits when they appear on the leaderboard. These credits contribute to overall performance scores and rankings.';
            }
            
            return 'I\'m here to help you with information about the EduPortal system. You can ask me about courses, attendance, assignments, grades, live meetings, previous papers, leaderboard, or any other features of the portal.';
        }

        function addChatMessage(message, type) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.style.background = type === 'user' ? 'var(--gradient-primary)' : 'rgba(255,255,255,0.1)';
            messageDiv.style.color = 'white';
            messageDiv.style.padding = '12px 18px';
            messageDiv.style.borderRadius = '18px';
            messageDiv.style.marginBottom = '15px';
            messageDiv.style.maxWidth = '85%';
            messageDiv.style.wordWrap = 'break-word';
            if (type === 'user') {
                messageDiv.style.marginLeft = 'auto';
                messageDiv.style.borderBottomRightRadius = '5px';
            } else {
                messageDiv.style.borderBottomLeftRadius = '5px';
            }
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Initialize
        document.getElementById('chatbotInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        document.getElementById('teacherChatInputField').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendTeacherMessage();
            }
        });

        // Set today's date as default for attendance
        document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('assignmentDueDate').valueAsDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // One week from now

        // Load saved theme when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTheme();
        });

        // Load initial data
        async function loadInitialData() {
            // These would be loaded from the server in a real application
            // For now, we'll initialize empty arrays
            enrollments = [];
            forumPosts = [];
            notifications = [];
            assignments = [];
            courses = [];
            timetables = [];
            previousPapers = [];
            semesterResults = [];
        }

        loadInitialData();
    </script>
</body>
</html>